import{a as Pe,u as L,m as Ae,j as e,P as D,M as O,d as P,k as E,e as Re}from"./ui-BG7jjlrC.js";import{r as u}from"./vendor-CsPsgsBv.js";import{d as oe,u as $,a as U,s as w,t as Te,e as _,b as Q,f as N,A as Le,M as K,T as ke,v as De,w as ze,D as Me,x as We,y as He,z as Fe,L as X}from"./index-CvhVXczW.js";import{A as ne,a as le,b as ie}from"./avatar-BFIKPfdM.js";import{L as qe,u as ae,b as Oe}from"./router-J7O6VmFe.js";import{T as $e,f as J}from"./formatDistanceToNow-CT3n5jHP.js";import{C as ce}from"./clock-CFGbNuaY.js";import{H as Ie}from"./heart-DNgORbql.js";import{b as Ye,u as Ve,c as B}from"./query-C_TmXHuV.js";import{T as Xe}from"./trash-2-ylsRDHL7.js";import"./utils-EL5wpLGY.js";import"./supabase-DoZrjKS4.js";import"./constructNow-CbkWqtaZ.js";import"./en-US-DcT3sm5m.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=oe("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=oe("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);function Qe(t){const{user:r}=$(),{toast:s}=U(),[a,o]=u.useState(0),[i,d]=u.useState(!1),[n,m]=u.useState(!1),l=async()=>{try{const{data:h,error:f}=await w.from("story_likes").select("id").eq("story_id",t);if(f)throw f;if(o(h?.length||0),r){const{data:x,error:g}=await w.from("story_likes").select("id").eq("story_id",t).eq("user_id",r.id).single();if(g&&g.code!=="PGRST116")throw g;d(!!x)}}catch(h){console.error("Error fetching likes:",h)}},c=async()=>{if(!r){s({title:"Authentication required",description:"Please log in to like stories",variant:"destructive"});return}m(!0);try{if(i){const{error:h}=await w.from("story_likes").delete().eq("story_id",t).eq("user_id",r.id);if(h)throw h;d(!1),o(f=>f-1)}else{const{error:h}=await w.from("story_likes").insert({story_id:t,user_id:r.id});if(h)throw h;d(!0),o(f=>f+1)}}catch(h){console.error("Error toggling like:",h),s({title:"Error",description:"Failed to update like status",variant:"destructive"})}finally{m(!1)}};return u.useEffect(()=>{l()},[t,r]),{likesCount:a,isLiked:i,isLoading:n,toggleLike:c}}function Ke(t,r){return u.useReducer((s,a)=>r[s][a]??s,t)}var G="ScrollArea",[de,At]=Pe(G),[Je,j]=de(G),ue=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,type:a="hover",dir:o,scrollHideDelay:i=600,...d}=t,[n,m]=u.useState(null),[l,c]=u.useState(null),[h,f]=u.useState(null),[x,g]=u.useState(null),[p,S]=u.useState(null),[v,A]=u.useState(0),[V,z]=u.useState(0),[M,k]=u.useState(!1),[W,H]=u.useState(!1),b=L(r,R=>m(R)),y=Ae(o);return e.jsx(Je,{scope:s,type:a,dir:y,scrollHideDelay:i,scrollArea:n,viewport:l,onViewportChange:c,content:h,onContentChange:f,scrollbarX:x,onScrollbarXChange:g,scrollbarXEnabled:M,onScrollbarXEnabledChange:k,scrollbarY:p,onScrollbarYChange:S,scrollbarYEnabled:W,onScrollbarYEnabledChange:H,onCornerWidthChange:A,onCornerHeightChange:z,children:e.jsx(D.div,{dir:y,...d,ref:b,style:{position:"relative","--radix-scroll-area-corner-width":v+"px","--radix-scroll-area-corner-height":V+"px",...t.style}})})});ue.displayName=G;var me="ScrollAreaViewport",he=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,children:a,asChild:o,nonce:i,...d}=t,n=j(me,s),m=u.useRef(null),l=L(r,m,n.onViewportChange);return e.jsxs(e.Fragment,{children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:`
[data-radix-scroll-area-viewport] {
  scrollbar-width: none;
  -ms-overflow-style: none;
  -webkit-overflow-scrolling: touch;
}
[data-radix-scroll-area-viewport]::-webkit-scrollbar {
  display: none;
}
:where([data-radix-scroll-area-viewport]) {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
:where([data-radix-scroll-area-content]) {
  flex-grow: 1;
}
`},nonce:i}),e.jsx(D.div,{"data-radix-scroll-area-viewport":"",...d,asChild:o,ref:l,style:{overflowX:n.scrollbarXEnabled?"scroll":"hidden",overflowY:n.scrollbarYEnabled?"scroll":"hidden",...t.style},children:it({asChild:o,children:a},c=>e.jsx("div",{"data-radix-scroll-area-content":"",ref:n.onContentChange,style:{minWidth:n.scrollbarXEnabled?"fit-content":void 0},children:c}))})]})});he.displayName=me;var C="ScrollAreaScrollbar",Z=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),{onScrollbarXEnabledChange:i,onScrollbarYEnabledChange:d}=o,n=t.orientation==="horizontal";return u.useEffect(()=>(n?i(!0):d(!0),()=>{n?i(!1):d(!1)}),[n,i,d]),o.type==="hover"?e.jsx(Ge,{...a,ref:r,forceMount:s}):o.type==="scroll"?e.jsx(Ze,{...a,ref:r,forceMount:s}):o.type==="auto"?e.jsx(fe,{...a,ref:r,forceMount:s}):o.type==="always"?e.jsx(ee,{...a,ref:r}):null});Z.displayName=C;var Ge=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),[i,d]=u.useState(!1);return u.useEffect(()=>{const n=o.scrollArea;let m=0;if(n){const l=()=>{window.clearTimeout(m),d(!0)},c=()=>{m=window.setTimeout(()=>d(!1),o.scrollHideDelay)};return n.addEventListener("pointerenter",l),n.addEventListener("pointerleave",c),()=>{window.clearTimeout(m),n.removeEventListener("pointerenter",l),n.removeEventListener("pointerleave",c)}}},[o.scrollArea,o.scrollHideDelay]),e.jsx(O,{present:s||i,children:e.jsx(fe,{"data-state":i?"visible":"hidden",...a,ref:r})})}),Ze=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),i=t.orientation==="horizontal",d=Y(()=>m("SCROLL_END"),100),[n,m]=Ke("hidden",{hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}});return u.useEffect(()=>{if(n==="idle"){const l=window.setTimeout(()=>m("HIDE"),o.scrollHideDelay);return()=>window.clearTimeout(l)}},[n,o.scrollHideDelay,m]),u.useEffect(()=>{const l=o.viewport,c=i?"scrollLeft":"scrollTop";if(l){let h=l[c];const f=()=>{const x=l[c];h!==x&&(m("SCROLL"),d()),h=x};return l.addEventListener("scroll",f),()=>l.removeEventListener("scroll",f)}},[o.viewport,i,m,d]),e.jsx(O,{present:s||n!=="hidden",children:e.jsx(ee,{"data-state":n==="hidden"?"hidden":"visible",...a,ref:r,onPointerEnter:P(t.onPointerEnter,()=>m("POINTER_ENTER")),onPointerLeave:P(t.onPointerLeave,()=>m("POINTER_LEAVE"))})})}),fe=u.forwardRef((t,r)=>{const s=j(C,t.__scopeScrollArea),{forceMount:a,...o}=t,[i,d]=u.useState(!1),n=t.orientation==="horizontal",m=Y(()=>{if(s.viewport){const l=s.viewport.offsetWidth<s.viewport.scrollWidth,c=s.viewport.offsetHeight<s.viewport.scrollHeight;d(n?l:c)}},10);return T(s.viewport,m),T(s.content,m),e.jsx(O,{present:a||i,children:e.jsx(ee,{"data-state":i?"visible":"hidden",...o,ref:r})})}),ee=u.forwardRef((t,r)=>{const{orientation:s="vertical",...a}=t,o=j(C,t.__scopeScrollArea),i=u.useRef(null),d=u.useRef(0),[n,m]=u.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),l=ve(n.viewport,n.content),c={...a,sizes:n,onSizesChange:m,hasThumb:l>0&&l<1,onThumbChange:f=>i.current=f,onThumbPointerUp:()=>d.current=0,onThumbPointerDown:f=>d.current=f};function h(f,x){return nt(f,d.current,n,x)}return s==="horizontal"?e.jsx(et,{...c,ref:r,onThumbPositionChange:()=>{if(o.viewport&&i.current){const f=o.viewport.scrollLeft,x=se(f,n,o.dir);i.current.style.transform=`translate3d(${x}px, 0, 0)`}},onWheelScroll:f=>{o.viewport&&(o.viewport.scrollLeft=f)},onDragScroll:f=>{o.viewport&&(o.viewport.scrollLeft=h(f,o.dir))}}):s==="vertical"?e.jsx(tt,{...c,ref:r,onThumbPositionChange:()=>{if(o.viewport&&i.current){const f=o.viewport.scrollTop,x=se(f,n);i.current.style.transform=`translate3d(0, ${x}px, 0)`}},onWheelScroll:f=>{o.viewport&&(o.viewport.scrollTop=f)},onDragScroll:f=>{o.viewport&&(o.viewport.scrollTop=h(f))}}):null}),et=u.forwardRef((t,r)=>{const{sizes:s,onSizesChange:a,...o}=t,i=j(C,t.__scopeScrollArea),[d,n]=u.useState(),m=u.useRef(null),l=L(r,m,i.onScrollbarXChange);return u.useEffect(()=>{m.current&&n(getComputedStyle(m.current))},[m]),e.jsx(pe,{"data-orientation":"horizontal",...o,ref:l,sizes:s,style:{bottom:0,left:i.dir==="rtl"?"var(--radix-scroll-area-corner-width)":0,right:i.dir==="ltr"?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":I(s)+"px",...t.style},onThumbPointerDown:c=>t.onThumbPointerDown(c.x),onDragScroll:c=>t.onDragScroll(c.x),onWheelScroll:(c,h)=>{if(i.viewport){const f=i.viewport.scrollLeft+c.deltaX;t.onWheelScroll(f),je(f,h)&&c.preventDefault()}},onResize:()=>{m.current&&i.viewport&&d&&a({content:i.viewport.scrollWidth,viewport:i.viewport.offsetWidth,scrollbar:{size:m.current.clientWidth,paddingStart:q(d.paddingLeft),paddingEnd:q(d.paddingRight)}})}})}),tt=u.forwardRef((t,r)=>{const{sizes:s,onSizesChange:a,...o}=t,i=j(C,t.__scopeScrollArea),[d,n]=u.useState(),m=u.useRef(null),l=L(r,m,i.onScrollbarYChange);return u.useEffect(()=>{m.current&&n(getComputedStyle(m.current))},[m]),e.jsx(pe,{"data-orientation":"vertical",...o,ref:l,sizes:s,style:{top:0,right:i.dir==="ltr"?0:void 0,left:i.dir==="rtl"?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":I(s)+"px",...t.style},onThumbPointerDown:c=>t.onThumbPointerDown(c.y),onDragScroll:c=>t.onDragScroll(c.y),onWheelScroll:(c,h)=>{if(i.viewport){const f=i.viewport.scrollTop+c.deltaY;t.onWheelScroll(f),je(f,h)&&c.preventDefault()}},onResize:()=>{m.current&&i.viewport&&d&&a({content:i.viewport.scrollHeight,viewport:i.viewport.offsetHeight,scrollbar:{size:m.current.clientHeight,paddingStart:q(d.paddingTop),paddingEnd:q(d.paddingBottom)}})}})}),[rt,xe]=de(C),pe=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,sizes:a,hasThumb:o,onThumbChange:i,onThumbPointerUp:d,onThumbPointerDown:n,onThumbPositionChange:m,onDragScroll:l,onWheelScroll:c,onResize:h,...f}=t,x=j(C,s),[g,p]=u.useState(null),S=L(r,b=>p(b)),v=u.useRef(null),A=u.useRef(""),V=x.viewport,z=a.content-a.viewport,M=E(c),k=E(m),W=Y(h,10);function H(b){if(v.current){const y=b.clientX-v.current.left,R=b.clientY-v.current.top;l({x:y,y:R})}}return u.useEffect(()=>{const b=y=>{const R=y.target;g?.contains(R)&&M(y,z)};return document.addEventListener("wheel",b,{passive:!1}),()=>document.removeEventListener("wheel",b,{passive:!1})},[V,g,z,M]),u.useEffect(k,[a,k]),T(g,W),T(x.content,W),e.jsx(rt,{scope:s,scrollbar:g,hasThumb:o,onThumbChange:E(i),onThumbPointerUp:E(d),onThumbPositionChange:k,onThumbPointerDown:E(n),children:e.jsx(D.div,{...f,ref:S,style:{position:"absolute",...f.style},onPointerDown:P(t.onPointerDown,b=>{b.button===0&&(b.target.setPointerCapture(b.pointerId),v.current=g.getBoundingClientRect(),A.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",x.viewport&&(x.viewport.style.scrollBehavior="auto"),H(b))}),onPointerMove:P(t.onPointerMove,H),onPointerUp:P(t.onPointerUp,b=>{const y=b.target;y.hasPointerCapture(b.pointerId)&&y.releasePointerCapture(b.pointerId),document.body.style.webkitUserSelect=A.current,x.viewport&&(x.viewport.style.scrollBehavior=""),v.current=null})})})}),F="ScrollAreaThumb",ge=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=xe(F,t.__scopeScrollArea);return e.jsx(O,{present:s||o.hasThumb,children:e.jsx(st,{ref:r,...a})})}),st=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,style:a,...o}=t,i=j(F,s),d=xe(F,s),{onThumbPositionChange:n}=d,m=L(r,h=>d.onThumbChange(h)),l=u.useRef(),c=Y(()=>{l.current&&(l.current(),l.current=void 0)},100);return u.useEffect(()=>{const h=i.viewport;if(h){const f=()=>{if(c(),!l.current){const x=lt(h,n);l.current=x,n()}};return n(),h.addEventListener("scroll",f),()=>h.removeEventListener("scroll",f)}},[i.viewport,c,n]),e.jsx(D.div,{"data-state":d.hasThumb?"visible":"hidden",...o,ref:m,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...a},onPointerDownCapture:P(t.onPointerDownCapture,h=>{const x=h.target.getBoundingClientRect(),g=h.clientX-x.left,p=h.clientY-x.top;d.onThumbPointerDown({x:g,y:p})}),onPointerUp:P(t.onPointerUp,d.onThumbPointerUp)})});ge.displayName=F;var te="ScrollAreaCorner",be=u.forwardRef((t,r)=>{const s=j(te,t.__scopeScrollArea),a=!!(s.scrollbarX&&s.scrollbarY);return s.type!=="scroll"&&a?e.jsx(ot,{...t,ref:r}):null});be.displayName=te;var ot=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,...a}=t,o=j(te,s),[i,d]=u.useState(0),[n,m]=u.useState(0),l=!!(i&&n);return T(o.scrollbarX,()=>{const c=o.scrollbarX?.offsetHeight||0;o.onCornerHeightChange(c),m(c)}),T(o.scrollbarY,()=>{const c=o.scrollbarY?.offsetWidth||0;o.onCornerWidthChange(c),d(c)}),l?e.jsx(D.div,{...a,ref:r,style:{width:i,height:n,position:"absolute",right:o.dir==="ltr"?0:void 0,left:o.dir==="rtl"?0:void 0,bottom:0,...t.style}}):null});function q(t){return t?parseInt(t,10):0}function ve(t,r){const s=t/r;return isNaN(s)?0:s}function I(t){const r=ve(t.viewport,t.content),s=t.scrollbar.paddingStart+t.scrollbar.paddingEnd,a=(t.scrollbar.size-s)*r;return Math.max(a,18)}function nt(t,r,s,a="ltr"){const o=I(s),i=o/2,d=r||i,n=o-d,m=s.scrollbar.paddingStart+d,l=s.scrollbar.size-s.scrollbar.paddingEnd-n,c=s.content-s.viewport,h=a==="ltr"?[0,c]:[c*-1,0];return we([m,l],h)(t)}function se(t,r,s="ltr"){const a=I(r),o=r.scrollbar.paddingStart+r.scrollbar.paddingEnd,i=r.scrollbar.size-o,d=r.content-r.viewport,n=i-a,m=s==="ltr"?[0,d]:[d*-1,0],l=Te(t,m);return we([0,d],[0,n])(l)}function we(t,r){return s=>{if(t[0]===t[1]||r[0]===r[1])return r[0];const a=(r[1]-r[0])/(t[1]-t[0]);return r[0]+a*(s-t[0])}}function je(t,r){return t>0&&t<r}var lt=(t,r=()=>{})=>{let s={left:t.scrollLeft,top:t.scrollTop},a=0;return function o(){const i={left:t.scrollLeft,top:t.scrollTop},d=s.left!==i.left,n=s.top!==i.top;(d||n)&&r(),s=i,a=window.requestAnimationFrame(o)}(),()=>window.cancelAnimationFrame(a)};function Y(t,r){const s=E(t),a=u.useRef(0);return u.useEffect(()=>()=>window.clearTimeout(a.current),[]),u.useCallback(()=>{window.clearTimeout(a.current),a.current=window.setTimeout(s,r)},[s,r])}function T(t,r){const s=E(r);Re(()=>{let a=0;if(t){const o=new ResizeObserver(()=>{cancelAnimationFrame(a),a=window.requestAnimationFrame(s)});return o.observe(t),()=>{window.cancelAnimationFrame(a),o.unobserve(t)}}},[t,s])}function it(t,r){const{asChild:s,children:a}=t;if(!s)return typeof r=="function"?r(a):r;const o=u.Children.only(a);return u.cloneElement(o,{children:typeof r=="function"?r(o.props.children):r})}var Se=ue,at=he,ct=be;const re=u.forwardRef(({className:t,children:r,...s},a)=>e.jsxs(Se,{ref:a,className:_("relative overflow-hidden",t),...s,children:[e.jsx(at,{className:"h-full w-full rounded-[inherit]",children:r}),e.jsx(ye,{}),e.jsx(ct,{})]}));re.displayName=Se.displayName;const ye=u.forwardRef(({className:t,orientation:r="vertical",...s},a)=>e.jsx(Z,{ref:a,orientation:r,className:_("flex touch-none select-none transition-colors",r==="vertical"&&"h-full w-1.5 border-l border-l-transparent p-[1px] opacity-0 hover:opacity-100",r==="horizontal"&&"h-1.5 flex-col border-t border-t-transparent p-[1px] opacity-0 hover:opacity-100",t),...s,children:e.jsx(ge,{className:"relative flex-1 rounded-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors"})}));ye.displayName=Z.displayName;function dt({currentStory:t}){const[r,s]=u.useState([]),[a,o]=u.useState(!0);return u.useEffect(()=>{(async()=>{try{const{data:d,error:n}=await w.from("stories").select("*").eq("tag_type",t.tag_type).neq("id",t.id).limit(5);if(n)throw n;const m=(d||[]).map(l=>{const c=l.tag_type;return{...l,tag_type:c,author:{name:"Anonymous",profile_image:null}}});s(m)}catch(d){console.error("Error fetching similar stories:",d)}finally{o(!1)}})()},[t.tag_type,t.id]),a?e.jsx("div",{className:"p-3",children:e.jsx("div",{className:"space-y-3",children:[1,2,3].map(i=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-muted rounded mb-2"}),e.jsx("div",{className:"h-3 bg-muted rounded w-3/4"})]},i))})}):r.length===0?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx($e,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"No similar stories found"})]}):e.jsx(re,{className:"h-full",children:e.jsx("div",{className:"p-3 space-y-3",children:r.map((i,d)=>e.jsx(qe,{to:`/story/${i.id}`,className:"block group",children:e.jsx("div",{className:"p-3 rounded-lg border border-border hover:border-[#037004] hover:bg-accent transition-all duration-200 group-hover:shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground text-sm line-clamp-2 group-hover:text-[#037004] transition-colors mb-1",children:i.title}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2 mb-2",children:i.snippet}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:"â€¢"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ce,{size:10}),e.jsx("span",{children:J(new Date(i.published_at),{addSuffix:!0})})]})]}),e.jsx("span",{className:"text-white text-xs py-0.5 px-2 rounded-full font-medium flex-shrink-0 bg-[#037004]",children:i.tags[0]})]})]})]})})},i.id))})})}function Ne({story:t}){const r=ae(),s=Math.ceil(t.content.split(" ").length/200),{likesCount:a,isLiked:o,isLoading:i,toggleLike:d}=Qe(t.id),n=Q(),m=l=>{switch(l){case"mental":return"bg-[#037004] text-white border-[#025803]";case"control":return"bg-blue-500 text-white border-blue-600";case"drugs":return"bg-red-500 text-white border-red-600";case"life":return"bg-orange-500 text-white border-orange-600";case"anxiety":return"bg-purple-500 text-white border-purple-600";case"depression":return"bg-indigo-500 text-white border-indigo-600";default:return"bg-gray-500 text-white border-gray-600"}};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:`${n?"p-3":"p-4 sm:p-6"} border-b border-border bg-card flex-shrink-0`,children:[e.jsx("div",{className:"flex flex-col gap-3 mb-3",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(N,{variant:"ghost",size:"sm",className:"flex items-center gap-1 text-[#037004] hover:text-[#025803] hover:bg-[#025803]/10 transition-colors px-2 py-1.5 h-auto",onClick:()=>r(-1),children:[e.jsx(Le,{size:16}),e.jsx("span",{className:"text-sm font-medium",children:"Back"})]}),e.jsx("div",{className:`text-xs py-1.5 px-3 rounded-full font-medium shadow-sm w-fit ${m(t.tag_type)}`,children:t.tags[0]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground text-xs",children:[e.jsx(ce,{size:12}),e.jsxs("span",{children:[s," min read"]})]})]})}),e.jsx("h1",{className:`font-bold text-foreground mb-4 leading-tight ${n?"text-lg":"text-xl sm:text-2xl lg:text-3xl"}`,children:t.title}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[t.is_anonymous?e.jsx("div",{className:"flex items-center flex-1 py-2",children:e.jsx("p",{className:`font-medium text-muted-foreground ${n?"text-sm":"text-base"}`,children:"Shared Anonymously"})}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(ne,{className:`ring-1 ring-[#037004] ${n?"h-8 w-8":"h-9 w-9"}`,children:[e.jsx(le,{src:t.author?.profile_image||void 0}),e.jsx(ie,{className:"bg-[#037004] text-white font-semibold text-sm",children:(t.author?.name||"A").charAt(0)})]}),e.jsxs("div",{children:[e.jsx("p",{className:`font-semibold text-foreground ${n?"text-sm":"text-base"}`,children:t.author?.name||"Anonymous"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Published ",J(new Date(t.published_at),{addSuffix:!0})]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("button",{onClick:d,disabled:i,className:_("flex items-center gap-1 px-3 py-1.5 text-xs rounded-full transition-colors","hover:bg-red-500/10 disabled:opacity-50 disabled:cursor-not-allowed",o?"text-red-500 bg-red-500/10":"text-muted-foreground hover:text-red-500"),children:[e.jsx(Ie,{size:14,className:_("transition-all",o?"fill-current":"")}),e.jsx("span",{children:a})]})})]})]}),e.jsx("div",{className:"flex-1 bg-background",children:e.jsxs("div",{className:`${n?"p-3":"p-4 sm:p-6"}`,children:[e.jsx("div",{className:"mb-6",children:e.jsx("img",{src:t.cover_image,alt:t.title,className:`w-full rounded-lg object-cover shadow-sm border border-border ${n?"h-40":"h-48 sm:h-64 lg:h-80"}`,onError:l=>{l.target.src="/placeholder.svg"}})}),e.jsx("div",{className:"prose prose-base lg:prose-lg max-w-none",children:e.jsx("div",{className:`text-foreground leading-relaxed space-y-4 ${n?"space-y-3":"space-y-6"}`,children:t.content.split(`

`).map((l,c)=>e.jsx("p",{className:`text-foreground ${n?"text-sm leading-6":"text-base lg:text-lg leading-7 lg:leading-8"}`,children:l},c))})}),e.jsxs("div",{className:`mt-6 pt-4 border-t border-border ${n?"mt-4":"mt-8 pt-6"}`,children:[e.jsx("h3",{className:`font-semibold mb-3 text-foreground ${n?"text-base":"text-lg mb-4"}`,children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.tags.map((l,c)=>e.jsxs("span",{className:`px-3 py-1.5 bg-[#037004]/20 text-[#037004] dark:text-[#4ade80] rounded-full font-medium hover:bg-[#037004]/30 transition-colors cursor-pointer border border-[#037004]/30 ${n?"text-xs":"text-sm"}`,children:["#",l]},c))})]}),e.jsxs("div",{className:`mt-6 pt-4 border-t border-border ${n?"mt-4":"mt-8 pt-6"}`,children:[e.jsx("h3",{className:`font-semibold mb-3 text-[#037004] ${n?"text-base":"text-lg mb-4"}`,children:"Similar Stories"}),e.jsx(dt,{currentStory:t})]})]})})]})}function ut(t){const{user:r}=$(),{toast:s}=U(),a=Ye(),{data:o=[],isLoading:i}=Ve({queryKey:["comments",t],queryFn:async()=>{const{data:l,error:c}=await w.from("story_comments").select(`
          *,
          users!user_id (
            name,
            profile_image
          )
        `).eq("story_id",t).order("created_at",{ascending:!0});if(c)throw c;let h=[];if(r){const{data:p,error:S}=await w.from("comment_votes").select("comment_id, vote_type").eq("user_id",r.id).in("comment_id",l?.map(v=>v.id)||[]);S||(h=p||[])}const f=(l||[]).map(p=>({id:p.id,story_id:p.story_id,user_id:p.user_id,parent_comment_id:p.parent_comment_id,content:p.content,upvotes:p.upvotes,downvotes:p.downvotes,is_edited:p.is_edited,created_at:p.created_at,updated_at:p.updated_at,author:p.users?{name:p.users.name,profile_image:p.users.profile_image}:void 0,user_vote:h.find(S=>S.comment_id===p.id)?.vote_type||null})),x=new Map,g=[];return f.forEach(p=>{x.set(p.id,{...p,replies:[]})}),f.forEach(p=>{if(p.parent_comment_id){const S=x.get(p.parent_comment_id);S&&S.replies.push(x.get(p.id))}else g.push(x.get(p.id))}),g},enabled:!!t}),d=B({mutationFn:async({content:l,parentCommentId:c})=>{if(!r)throw new Error("Must be logged in to comment");const{data:h,error:f}=await w.from("story_comments").insert({story_id:t,user_id:r.id,parent_comment_id:c||null,content:l}).select().single();if(f)throw f;return h},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]}),s({title:"Comment posted",description:"Your comment has been added successfully."})},onError:l=>{s({title:"Failed to post comment",description:l.message||"Could not post your comment",variant:"destructive"})}}),n=B({mutationFn:async({commentId:l,voteType:c})=>{if(!r)throw new Error("Must be logged in to vote");if(c===null){const{error:h}=await w.from("comment_votes").delete().eq("comment_id",l).eq("user_id",r.id);if(h)throw h}else{const{error:h}=await w.from("comment_votes").upsert({comment_id:l,user_id:r.id,vote_type:c});if(h)throw h}},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]})},onError:l=>{s({title:"Failed to vote",description:l.message||"Could not register your vote",variant:"destructive"})}}),m=B({mutationFn:async l=>{if(!r)throw new Error("Must be logged in to delete comments");const{error:c}=await w.from("story_comments").delete().eq("id",l).eq("user_id",r.id);if(c)throw c},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]}),s({title:"Comment deleted",description:"Your comment has been deleted successfully."})},onError:l=>{s({title:"Failed to delete comment",description:l.message||"Could not delete your comment",variant:"destructive"})}});return{comments:o,isLoading:i,addComment:d.mutate,voteComment:n.mutate,deleteComment:m.mutate,isAddingComment:d.isPending,isVoting:n.isPending,isDeleting:m.isPending}}function Ce({onSubmit:t,onCancel:r,placeholder:s="Write a comment...",submitText:a="Post Comment",isSubmitting:o=!1,isReply:i=!1}){const[d,n]=u.useState(""),{isAuthenticated:m}=$(),l=c=>{c.preventDefault(),d.trim()&&(t(d.trim()),n(""))};return m?e.jsxs("form",{onSubmit:l,className:"space-y-3",children:[e.jsx(ke,{value:d,onChange:c=>n(c.target.value),placeholder:s,className:"min-h-[80px] resize-none",disabled:o}),e.jsxs("div",{className:"flex justify-end gap-2",children:[r&&e.jsx(N,{type:"button",variant:"outline",onClick:r,disabled:o,children:"Cancel"}),e.jsx(N,{type:"submit",disabled:!d.trim()||o,size:i?"sm":"default",className:"bg-[#037004] hover:bg-[#025803] text-white",children:o?"Posting...":a})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground bg-muted rounded-lg border border-border",children:[e.jsx(K,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{children:"Please log in to join the discussion"})]})}function _e({comment:t,onVote:r,onReply:s,onDelete:a,isVoting:o=!1,isReplying:i=!1,isDeleting:d=!1,depth:n=0}){const[m,l]=u.useState(!1),[c,h]=u.useState(!1),{user:f}=$(),x=v=>{const A=t.user_vote===v?null:v;r(t.id,A)},g=v=>{s(t.id,v),l(!1)},p=t.upvotes-t.downvotes;return e.jsxs("div",{className:_("space-y-3",n>0&&"ml-6 border-l-2 border-gray-100 pl-4"),children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(ne,{className:"h-6 w-6",children:[e.jsx(le,{src:t.author?.profile_image||void 0}),e.jsx(ie,{className:"text-xs",children:t.author?.name?.charAt(0)||"A"})]}),e.jsx("span",{className:"font-medium text-sm",children:t.author?.name||"Anonymous"}),e.jsx("span",{className:"text-xs text-gray-500",children:J(new Date(t.created_at),{addSuffix:!0})}),t.is_edited&&e.jsx("span",{className:"text-xs text-gray-400",children:"(edited)"})]}),!c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{variant:"ghost",size:"sm",className:_("h-6 px-1",t.user_vote==="upvote"&&"text-orange-500 bg-orange-50"),onClick:()=>x("upvote"),disabled:o,children:e.jsx(De,{size:14})}),e.jsx("span",{className:_("text-xs font-medium min-w-[20px] text-center",p>0&&"text-orange-500",p<0&&"text-blue-500"),children:p}),e.jsx(N,{variant:"ghost",size:"sm",className:_("h-6 px-1",t.user_vote==="downvote"&&"text-blue-500 bg-blue-50"),onClick:()=>x("downvote"),disabled:o,children:e.jsx(ze,{size:14})})]}),n<6&&e.jsxs(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>l(!m),children:[e.jsx(Ue,{size:12,className:"mr-1"}),"Reply"]}),t.replies&&t.replies.length>0&&e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>h(!c),children:c?`[+] ${t.replies.length} replies`:"[-]"}),f&&f.id===t.user_id&&e.jsxs(Me,{children:[e.jsx(We,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 px-1",children:e.jsx(Be,{size:12})})}),e.jsx(He,{align:"end",children:e.jsxs(Fe,{onClick:()=>a(t.id),disabled:d,className:"text-destructive focus:text-destructive",children:[e.jsx(Xe,{size:12,className:"mr-2"}),"Delete"]})})]})]})]}),c&&e.jsxs(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-gray-500",onClick:()=>h(!1),children:["[+] ",t.author?.name," (",p," points) - ",t.replies?.length||0," replies"]}),m&&!c&&e.jsx("div",{className:"mt-3",children:e.jsx(Ce,{onSubmit:g,onCancel:()=>l(!1),placeholder:"Write a reply...",submitText:"Reply",isSubmitting:i,isReply:!0})})]}),!c&&t.replies&&t.replies.length>0&&e.jsx("div",{className:"space-y-3",children:t.replies.map(v=>e.jsx(_e,{comment:v,onVote:r,onReply:s,onDelete:a,isVoting:o,isReplying:i,isDeleting:d,depth:n+1},v.id))})]})}function Ee({storyId:t}){const{comments:r,isLoading:s,addComment:a,voteComment:o,deleteComment:i,isAddingComment:d,isVoting:n,isDeleting:m}=ut(t),l=x=>{a({content:x})},c=(x,g)=>{a({content:g,parentCommentId:x})},h=(x,g)=>{o({commentId:x,voteType:g})},f=x=>{i(x)};return s?e.jsx("div",{className:"h-full flex items-center justify-center p-4",children:e.jsx("div",{className:"text-center text-[#037004]",children:"Loading comments..."})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-border bg-muted flex-shrink-0",children:e.jsx(Ce,{onSubmit:l,isSubmitting:d})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(re,{className:"h-full",children:r.length===0?e.jsxs("div",{className:"text-center py-6 px-4 text-muted-foreground",children:[e.jsx(K,{className:"mx-auto h-8 w-8 mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No comments yet. Be the first to share your thoughts!"})]}):e.jsx("div",{className:"p-3 space-y-3",children:r.map(x=>e.jsx(_e,{comment:x,onVote:h,onReply:c,onDelete:f,isVoting:n,isReplying:d,isDeleting:m},x.id))})})})]})}function mt({story:t}){const[r,s]=u.useState(!1);return e.jsx("div",{className:"space-y-4 pb-4",children:r?e.jsxs("div",{className:"bg-card rounded-lg shadow-sm border border-border min-h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"p-3 border-b border-border bg-muted",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-lg",children:"Discussion"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:['Join the conversation about "',t.title,'"']})]}),e.jsx("div",{className:"h-[calc(100vh-12rem)]",children:e.jsx(Ee,{storyId:t.id})}),e.jsx("div",{className:"mt-3 flex justify-center",children:e.jsx(N,{variant:"outline",size:"sm",onClick:()=>s(!1),className:"text-[#037004] border-[#037004]",children:"Back to Story"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-card rounded-lg shadow-sm border border-border",children:e.jsx(Ne,{story:t})}),e.jsx("div",{className:"flex justify-center pb-20",children:e.jsxs(N,{onClick:()=>s(!0),className:"bg-[#037004] hover:bg-[#025803] text-white flex items-center gap-2 px-6 py-3 rounded-full shadow-lg",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"View Comments & Discussion"})]})})]})})}function ht({story:t}){return Q()?e.jsx(mt,{story:t}):e.jsxs("div",{className:"flex gap-6 h-full",children:[e.jsx("div",{className:"flex-1 lg:w-2/3 flex flex-col min-h-0",children:e.jsx("div",{className:"bg-card rounded-xl shadow-sm border border-border flex-1 flex flex-col overflow-hidden",children:e.jsx("div",{className:"flex-1 overflow-y-auto scrollbar-hide",children:e.jsx(Ne,{story:t})})})}),e.jsx("div",{className:"lg:w-1/3 flex flex-col min-h-0",children:e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-border bg-muted flex-shrink-0",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-xl",children:"Discussion"}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Join the conversation"})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(Ee,{storyId:t.id})})]})})]})}function Rt(){const{storyId:t}=Oe(),r=ae(),{toast:s}=U(),[a,o]=u.useState(null),[i,d]=u.useState(!0);u.useState(!1);const n=Q();return u.useEffect(()=>{(async()=>{try{if(!t){r("/");return}const{data:l,error:c}=await w.from("stories").select("*").eq("id",t).single();if(c)throw c;if(l){let h={name:"Anonymous",profile_image:null};if(l.author_id){const{data:g,error:p}=await w.from("users").select("name, profile_image").eq("id",l.author_id).single();!p&&g&&(h=g)}const f=l.tag_type,x={...l,tag_type:f,author:h};o(x),document.title=`${l.title} | Our Minds`}else r("/")}catch(l){console.error("Error fetching story:",l),s({title:"Failed to load story",description:l.message||"Could not retrieve the story",variant:"destructive"}),r("/")}finally{d(!1)}})()},[t,r,s]),i?e.jsx(X,{children:e.jsx("div",{className:"bg-background",children:e.jsx("div",{className:"container mx-auto p-4 lg:p-6",children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-pulse text-[#037004]",children:"Loading story..."})})})})}):a?e.jsx(X,{children:e.jsx("div",{className:`bg-background ${n?"min-h-screen":"h-full overflow-hidden"} flex flex-col`,children:e.jsx("div",{className:`${n?"flex flex-col":"flex-1 flex flex-col min-h-0"} ${n?"p-2":"p-4 lg:p-6"} max-w-7xl mx-auto w-full`,children:e.jsx("div",{className:n?"":"flex-1 min-h-0 overflow-hidden",children:e.jsx(ht,{story:a})})})})}):e.jsx(X,{children:e.jsx("div",{className:"bg-background",children:e.jsx("div",{className:"container mx-auto p-4 lg:p-6",children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("p",{className:"text-muted-foreground",children:"Story not found"})})})})})}export{Rt as StoryPage,Rt as default};
