import{j as e}from"./ui-BG7jjlrC.js";import{d as E,s as g,u as w,b as N,e as v,U as $,a as M,f as _,S as P,L as O}from"./index-0GCDgpXN.js";import{r as u,b as A}from"./vendor-CsPsgsBv.js";import{u as j,b as D,c as F}from"./query-C_TmXHuV.js";import{S as L}from"./search-2-Hy9YC1.js";import{M as S,A as R}from"./AuthRedirect-TYSOWIAx.js";import{f as B}from"./chatUtils-kffo14Ea.js";import{u as I,b as H}from"./router-J7O6VmFe.js";import{A as K}from"./arrow-left-B-J44Nj5.js";import"./utils-EL5wpLGY.js";import"./supabase-DoZrjKS4.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=E("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=E("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=E("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);async function W(t){if(!t)return[];console.log("Fetching chat threads for user:",t);try{const{data:r,error:a}=await g.from("chat_threads").select("*").or(`user_id.eq.${t},consultant_id.eq.${t}`).order("last_message_at",{ascending:!1});if(a)throw console.error("Error fetching threads:",a),a;return r}catch(r){throw console.error("Error in chat threads query:",r),r}}async function V(t){if(!t||t.length===0)return{};const r=t.map(s=>s.id),a={};try{const{data:s,error:n}=await g.from("chat_messages").select("*").in("thread_id",r).order("created_at",{ascending:!1});if(n)throw console.error("Error fetching messages:",n),n;return s?.forEach(i=>{a[i.thread_id]||(a[i.thread_id]=[]),a[i.thread_id].push(i)}),a}catch(s){throw console.error("Error fetching messages:",s),s}}async function J(t){if(!t||t.length===0)return{};const r=new Set;t.forEach(a=>{r.add(a.user_id),r.add(a.consultant_id)});try{const{data:a,error:s}=await g.from("users").select("id, name, profile_image").in("id",Array.from(r));if(s)throw console.error("Error fetching user profiles:",s),s;const n={};return a?.forEach(i=>{n[i.id]=i}),n}catch(a){throw console.error("Error fetching user profiles:",a),a}}function X(t,r,a,s){try{return r.map(n=>{const i=n.user_id===t.id?n.consultant_id:n.user_id,o=s?.[i]||{id:i,name:"Unknown User",profile_image:"/placeholder.svg"},l=a?.[n.id]||[],c=l.length>0?l[0]:void 0;return{thread:n,lastMessage:c,otherParticipant:o}})}catch(n){return console.error("Error processing thread data:",n),[]}}function Z(t,r){const a=g.channel("chat_threads_changes").on("postgres_changes",{event:"*",schema:"public",table:"chat_threads",filter:`user_id=eq.${t}`},()=>{console.log("User chat thread changed, refetching..."),r()}).on("postgres_changes",{event:"*",schema:"public",table:"chat_threads",filter:`consultant_id=eq.${t}`},()=>{console.log("Consultant chat thread changed, refetching..."),r()}).subscribe(),s=g.channel("chat_messages_changes").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},()=>{console.log("New message detected, refetching threads..."),r()}).subscribe();return()=>{g.removeChannel(a),g.removeChannel(s)}}function ee(){const{user:t}=w(),{data:r,error:a,refetch:s}=j({queryKey:["chatThreads",t?.id],queryFn:()=>W(t?.id),enabled:!!t?.id,staleTime:5*60*1e3,gcTime:10*60*1e3}),{data:n,error:i}=j({queryKey:["chatMessages",r?.map(d=>d.id)],queryFn:()=>V(r),enabled:!!r&&r.length>0,staleTime:2*60*1e3}),{data:o,error:l}=j({queryKey:["userProfiles",r?.map(d=>[d.user_id,d.consultant_id]).flat()],queryFn:()=>J(r),enabled:!!r&&r.length>0,staleTime:10*60*1e3});return u.useEffect(()=>t?.id?Z(t.id,s):void 0,[t?.id,s]),{threads:u.useMemo(()=>X(t,r||[],n,o),[t,r,n,o]),isLoading:!r,error:a||i||l}}function te({value:t,onChange:r}){const a=N();return e.jsxs("div",{className:"relative",children:[e.jsx(L,{className:`
        absolute left-3 top-1/2 transform -translate-y-1/2 
        text-gray-400 dark:text-gray-500
        ${a?"w-4 h-4":"w-5 h-5"}
      `}),e.jsx("input",{type:"text",placeholder:"Search conversations...",className:`
          w-full rounded-xl border border-gray-200 dark:border-[#30363d] 
          focus:outline-none focus:ring-2 focus:ring-[#025803] focus:border-transparent 
          text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 
          bg-gray-50 dark:bg-[#0d1117] transition-all
          ${a?"pl-9 pr-4 py-2.5 text-base":"pl-10 pr-4 py-3 text-sm"}
        `,value:t,onChange:s=>r(s.target.value)})]})}function C(){const{user:t}=w(),[r,a]=u.useState(new Set),[s,n]=u.useState(null);u.useEffect(()=>{if(!t)return;const o=g.channel("online_users");return o.on("presence",{event:"sync"},()=>{const l=o.presenceState(),c=new Set;Object.keys(l).forEach(d=>{const m=l[d];m&&m.length>0&&m.forEach(h=>{h.user_id&&c.add(h.user_id)})}),a(c),console.log("Online users updated:",Array.from(c))}).on("presence",{event:"join"},({key:l,newPresences:c})=>{console.log("User joined:",l,c)}).on("presence",{event:"leave"},({key:l,leftPresences:c})=>{console.log("User left:",l,c)}).subscribe(async l=>{if(l==="SUBSCRIBED"){const c={user_id:t.id,online_at:new Date().toISOString(),user_info:{name:t.user_metadata?.name||t.email||"Unknown User",profile_image:t.user_metadata?.avatar_url}};await o.track(c),console.log("User presence tracked:",c)}}),n(o),()=>{o&&(o.untrack(),g.removeChannel(o))}},[t]);const i=o=>r.has(o);return{onlineUsers:Array.from(r),isUserOnline:i,presenceChannel:s}}function re({thread:t}){const{user:r}=w(),{isUserOnline:a}=C(),{lastMessage:s,otherParticipant:n}=t,i="https://raw.githubusercontent.com/Our-Minds/our-minds.github.io/refs/heads/main/public/assets/default.png",o=n?.profile_image?n.profile_image:i,l=a(n.id);return e.jsxs("div",{className:"w-full flex items-center gap-3 p-4 group transition-all duration-150",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("img",{src:o,alt:n?.name||"User",className:"w-11 h-11 rounded-full object-cover ring-1 ring-[#e0e4dd] dark:ring-[#222] shadow group-hover:ring-[#025803]/40 transition-all duration-100",onError:c=>{c.target.src=i}}),e.jsx("div",{className:`absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#1a1a1a] shadow
            ${l?"bg-green-400 animate-pulse":"bg-gray-400"}
          `})]}),e.jsxs("div",{className:"ml-1 text-left flex-1 overflow-hidden",children:[e.jsxs("div",{className:"flex justify-between items-start mb-0.5",children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 truncate text-base",children:n?.name||"Unknown User"}),s&&e.jsx("span",{className:"text-xs text-gray-400 dark:text-gray-500 whitespace-nowrap ml-2 font-medium",children:new Date(s.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),s&&e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-300 truncate leading-relaxed",children:[e.jsx("span",{className:v(s.sender_id===r?.id?"text-[#025803] dark:text-[#025803] font-medium":""),children:s.sender_id===r?.id?"You: ":""}),s.content]})]})]})}function ae({selectedChatId:t,onSelectChat:r}){w();const{threads:a,isLoading:s,error:n}=ee(),[i,o]=u.useState(""),l=N(),c=a.filter(d=>i?d.otherParticipant.name?.toLowerCase().includes(i.toLowerCase()):!0);return n?e.jsx("div",{className:"h-full flex items-center justify-center",children:e.jsxs("div",{className:"text-center p-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-3",children:e.jsx(S,{className:"w-6 h-6 text-red-600 dark:text-red-400"})}),e.jsx("p",{className:"text-red-600 dark:text-red-400 font-medium",children:"Error loading chats"}),e.jsx("p",{className:"text-red-400 dark:text-red-500 text-sm mt-1",children:n.message})]})}):e.jsxs("div",{className:`
      h-full flex flex-col bg-white dark:bg-[#1a1a1a] overflow-hidden
      ${l?"rounded-none":"rounded-xl shadow-lg border border-gray-100 dark:border-[#2a2a2a]"}
      animate-fade-in
    `,children:[e.jsxs("div",{className:`
        shrink-0 bg-white dark:bg-[#1a1a1a]
        ${l?"p-3":"p-5"} 
        border-b border-gray-100 dark:border-[#2a2a2a]
      `,children:[e.jsxs("div",{className:`
          flex items-center gap-3 
          ${l?"mb-2":"mb-3"}
        `,children:[e.jsx("div",{className:"w-9 h-9 bg-mental-green-100 dark:bg-[#025803]/20 rounded-full flex items-center justify-center",children:e.jsx(S,{className:"w-5 h-5 text-mental-green-600 dark:text-[#025803]"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-gray-900 dark:text-gray-100",children:"Messages"}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[c.length," conversations"]})]})]}),e.jsx(te,{value:i,onChange:o})]}),e.jsx("div",{className:"flex-1 overflow-y-auto overflow-x-hidden scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:hover:scrollbar-thumb-gray-500 min-h-0",children:s?e.jsx("div",{className:`${l?"p-3":"p-5"} space-y-4`,children:Array.from({length:3}).map((d,m)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 bg-gray-200 dark:bg-[#2a2a2a] rounded-full animate-pulse"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-gray-200 dark:bg-[#2a2a2a] rounded animate-pulse mb-2"}),e.jsx("div",{className:"h-3 bg-gray-100 dark:bg-[#2f2f2f] rounded animate-pulse w-2/3"})]})]},m))}):c.length===0?e.jsx("div",{className:`flex-1 flex items-center justify-center ${l?"p-4":"p-6"}`,children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-100 dark:bg-[#2a2a2a] rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx($,{className:"w-8 h-8 text-gray-400 dark:text-gray-500"})}),e.jsx("h3",{className:"font-medium text-gray-900 dark:text-gray-100 mb-1",children:i?"No chats found":"No conversations yet"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:i?"Try searching for someone else":"Start a conversation with a consultant"})]})}):e.jsx("div",{className:"space-y-1 p-1 md:p-2",children:c.map(d=>e.jsx("div",{className:`
                  cursor-pointer rounded-xl transition-all duration-200 animate-fade-in
                  active:scale-96 touch-manipulation
                  ${t===d.thread.id?"bg-[#025803]/10 border border-[#025803]/40 dark:bg-[#025803]/20 dark:border-[#025803]/30 shadow-sm scale-105":"hover:bg-gray-50 dark:hover:bg-[#252525] active:bg-gray-100 dark:active:bg-[#2a2a2a]"}
                `,onClick:()=>r(d.thread.id),children:e.jsx(re,{thread:d})},d.thread.id))})})]})}function se(t,r){const[a,s]=u.useState(""),{user:n}=w(),i=I(),{toast:o}=M(),l=D();return u.useEffect(()=>{r&&s(r)},[r]),u.useEffect(()=>{t&&n&&(async()=>{try{const{data:d,error:m}=await g.from("chat_threads").select("*").eq("id",t).maybeSingle();if(!m&&d){s(t),i(`/chat/${t}`,{replace:!0});return}const h=await B(t,n.id);s(h.id),i(`/chat/${h.id}`,{replace:!0}),l.invalidateQueries({queryKey:["chatThreads"]})}catch(d){console.error("Error setting up chat thread:",d),o({title:"Error",description:"Could not create chat thread",variant:"destructive"})}})()},[t,n,l,o,i]),{selectedChatId:a,setSelectedChatId:s}}async function ne(t){if(!t)return null;const{data:r,error:a}=await g.from("chat_threads").select("*").eq("id",t).single();if(a)throw a;const s=[r.user_id,r.consultant_id],{data:n,error:i}=await g.from("users").select("id, name, profile_image").in("id",s);if(i)throw i;return{thread:r,participants:n}}async function ie(t){const{data:r,error:a}=await g.from("chat_messages").select("*").eq("thread_id",t).order("created_at",{ascending:!0});if(a)throw a;return r}async function oe(t,r,a,s){if(!t||!r)throw new Error("No chat selected");const n={thread_id:r,sender_id:t.id,content:a,attachment_url:s?.url,attachment_type:s?.type,attachment_name:s?.name,attachment_size:s?.size},{error:i}=await g.from("chat_messages").insert([n]);if(i)throw i;const{error:o}=await g.from("chat_threads").update({last_message_at:new Date().toISOString()}).eq("id",r);if(o)throw o}function le(t,r){const a=g.channel("chat-updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:`thread_id=eq.${t}`},()=>{r.invalidateQueries({queryKey:["messages",t]})}).subscribe();return()=>{g.removeChannel(a)}}async function ce(t,r,a){try{await g.rpc("mark_messages_as_read",{p_thread_id:t,p_user_id:r}),a.invalidateQueries({queryKey:["unreadMessages"]})}catch(s){console.error("Error marking messages as read:",s)}}function de(t,r,a){const s=[];if(t&&a){s.push({id:a.id,name:"You",image:a?.user_metadata?.avatar_url||""});const i=t.thread.user_id===a.id?t.thread.consultant_id:t.thread.user_id,o=t.participants?.find(l=>l.id===i);o&&s.push({id:o.id,name:o.name||"User",image:o.profile_image||""})}const n=r?.map(i=>({id:i.id,senderId:i.sender_id,content:i.content,timestamp:i.created_at,senderName:i.sender_id===a?.id?"You":s.find(o=>o.id===i.sender_id)?.name||"Other User",senderImage:i.sender_id===a?.id?a.user_metadata?.avatar_url||"":s.find(o=>o.id===i.sender_id)?.image||"",attachment_url:i.attachment_url,attachment_type:i.attachment_type,attachment_name:i.attachment_name,attachment_size:i.attachment_size}))??[];return{chatParticipants:s,transformedMessages:n}}function he(t){const{user:r}=w(),a=D(),{toast:s}=M(),{data:n,isLoading:i}=j({queryKey:["threadDetails",t],queryFn:()=>ne(t),enabled:!!t}),{data:o}=j({queryKey:["messages",t],queryFn:()=>ie(t),enabled:!!t}),l=F({mutationFn:({content:m,attachment:h})=>oe(r,t,m,h),onError:m=>{s({title:"Error sending message",description:m.message,variant:"destructive"})},onSuccess:()=>{a.invalidateQueries({queryKey:["messages",t]}),a.invalidateQueries({queryKey:["chatThreads"]})}});u.useEffect(()=>{!t||!r||ce(t,r.id,a)},[t,r,o,a]),u.useEffect(()=>{if(t)return le(t,a)},[t,a]);const{chatParticipants:c,transformedMessages:d}=de(n,o,r);return{threadDetails:n,isLoadingThreadDetails:i,chatParticipants:c,transformedMessages:d,sendMessage:(m,h)=>l.mutate({content:m,attachment:h})}}function q({participants:t,currentUserId:r,className:a}){const{isUserOnline:s}=C(),n="https://raw.githubusercontent.com/Our-Minds/our-minds.github.io/refs/heads/main/public/assets/default.png";return e.jsx("div",{className:v("flex items-center w-full gap-6",a,"animate-fade-in"),children:t.filter(i=>i.id!==r).map(i=>{const o=s(i.id),l=i.image?i.image:n;return e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:l,alt:i.name,className:"w-12 h-12 rounded-full object-cover ring-2 ring-mental-green-100 dark:ring-[#025803]/30 shadow-lg",onError:c=>{c.target.src=n}}),e.jsx("div",{className:`absolute -bottom-1.5 -right-1.5 w-4 h-4 rounded-full border-2 border-white dark:border-[#1a1a1a] shadow ${o?"bg-green-400 animate-pulse":"bg-gray-400"}`,title:o?"Online":"Offline"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900 dark:text-gray-100 text-lg",children:i.name}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${o?"bg-green-400":"bg-gray-400"}`}),e.jsx("p",{className:`text-sm font-medium ${o?"text-green-600 dark:text-green-400":"text-gray-500 dark:text-gray-400"}`,children:o?"Online":"Offline"})]})]})]},i.id)})})}function ue({chatParticipants:t,currentUserId:r}){return e.jsx("div",{className:"sticky top-0 shrink-0 z-20 shadow-sm border-b border-gray-100 dark:border-[#2a2a2a] bg-white/95 dark:bg-[#1a1a1a]/95 backdrop-blur-sm",children:e.jsx(q,{participants:t,currentUserId:r,className:"px-6 py-4"})})}const me=t=>{const r=[];let a="";return t.forEach(s=>{const n=new Date(s.timestamp).toLocaleDateString();n!==a?(a=n,r.push({date:n,messages:[s]})):r[r.length-1].messages.push(s)}),r},ge=t=>{const r=new Date(t),a=new Date,s=new Date(a);return s.setDate(s.getDate()-1),r.toDateString()===a.toDateString()?"Today":r.toDateString()===s.toDateString()?"Yesterday":r.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})},fe=t=>{if(t===0)return"0 Bytes";const r=1024,a=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(t)/Math.log(r));return parseFloat((t/Math.pow(r,s)).toFixed(2))+" "+a[s]},xe=t=>t.startsWith("image/");function pe({message:t,isMobile:r}){if(!t.attachment_url)return null;const a=t.attachment_type&&xe(t.attachment_type);return e.jsx("div",{className:"mt-2",children:a?e.jsx("img",{src:t.attachment_url,alt:t.attachment_name||"Attachment",className:`
            rounded-md max-w-full cursor-pointer
            ${r?"max-h-48":"max-h-64"}
          `,onClick:()=>window.open(t.attachment_url,"_blank")}):e.jsx("div",{className:"bg-white/10 dark:bg-black/20 rounded-md p-3 border border-white/20 dark:border-gray-600/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-white/20 dark:bg-gray-600/30 rounded flex items-center justify-center",children:"ðŸ“„"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:t.attachment_name||"File"}),t.attachment_size&&e.jsx("p",{className:"text-xs opacity-75",children:fe(t.attachment_size)})]}),e.jsx("button",{onClick:()=>window.open(t.attachment_url,"_blank"),className:"text-xs px-2 py-1 bg-white/20 dark:bg-gray-600/30 rounded hover:bg-white/30 dark:hover:bg-gray-600/50",children:"Open"})]})})})}function be({message:t,isCurrentUser:r,isMobile:a}){return e.jsx("div",{className:v("flex mb-3",r?"justify-end":"justify-start"),children:e.jsxs("div",{className:`
        ${a?"max-w-[85%]":"max-w-[70%]"}
      `,children:[e.jsxs("div",{className:v("p-3 rounded-lg break-words whitespace-pre-wrap break-all overflow-hidden",a?"text-sm":"text-base",r?"bg-[#025803] text-white rounded-br-none":"bg-gray-100 dark:bg-[#2a2a2a] text-gray-800 dark:text-gray-200 rounded-bl-none"),children:[t.content,t.image&&e.jsx("img",{src:t.image,alt:"Message attachment",className:`
                mt-2 rounded-md max-w-full h-auto
                ${a?"max-h-48":"max-h-64"}
              `}),e.jsx(pe,{message:t,isMobile:a})]}),e.jsx("div",{className:v("text-xs text-gray-500 dark:text-gray-400 mt-1",r?"text-right":"text-left"),children:new Date(t.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})})}function ye({group:t,chat:r,isMobile:a}){return e.jsxs("div",{className:a?"mb-4":"mb-6",children:[e.jsx("div",{className:"flex justify-center mb-3",children:e.jsx("span",{className:`
          px-3 py-1 bg-gray-100 dark:bg-[#2a2a2a] rounded-full 
          font-medium text-gray-600 dark:text-gray-300
          text-xs
        `,children:ge(t.date)})}),t.messages.map(s=>{const n=r.participants.find(i=>i.name==="You")?.id===s.senderId;return e.jsx(be,{message:s,isCurrentUser:n,isMobile:a},s.id)})]})}function we({chat:t,isMobile:r,messageAreaBottomPadding:a}){const s=u.useRef(null),n=u.useRef(null),i=u.useRef(0),[o,l]=u.useState(100),[c,d]=u.useState(!0),m=()=>{const f=n.current;if(!f)return!1;const{scrollTop:x,scrollHeight:y,clientHeight:z}=f;return y-x-z<100};u.useEffect(()=>{const f=n.current;if(!f)return;const x=()=>{d(m())};return f.addEventListener("scroll",x),()=>f.removeEventListener("scroll",x)},[]),u.useEffect(()=>{const f=t.messages.length>i.current;if(c||f){const y=setTimeout(()=>{s.current?.scrollIntoView({behavior:f?"smooth":"auto"})},100);return i.current=t.messages.length,()=>clearTimeout(y)}i.current=t.messages.length},[t.messages.length,c]),u.useEffect(()=>{setTimeout(()=>{s.current?.scrollIntoView({behavior:"auto"})},100)},[t.id]);const h=t.messages.slice(-o),p=me(h),b=t.messages.length>o,k=()=>{const f=n.current,x=f?.scrollHeight||0;l(y=>y+100),setTimeout(()=>{if(f){const y=f.scrollHeight;f.scrollTop=y-x}},0)};return e.jsx("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:e.jsx("div",{ref:n,className:v("flex-1 min-h-0 overflow-y-auto overflow-x-hidden overscroll-contain scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent hover:scrollbar-thumb-gray-400 dark:hover:scrollbar-thumb-gray-500"),style:{WebkitOverflowScrolling:"touch"},children:e.jsxs("div",{className:v("px-3 pt-4",a),children:[b&&e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(_,{variant:"outline",size:"sm",onClick:k,className:"text-xs",children:"Load earlier messages"})}),p.map((f,x)=>e.jsx(ye,{group:f,chat:t,isMobile:r},x)),e.jsx("div",{ref:s})]})})})}const ve=async(t,r)=>{if(t.size>10485760)throw new Error("File size must be less than 10MB");if(!["image/jpeg","image/png","image/gif","image/webp","application/pdf","text/plain","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"].includes(t.type))throw new Error("File type not supported");const n=t.name.split(".").pop(),i=`${r}/${Date.now()}_${Math.random().toString(36).substring(2)}.${n}`,{data:o,error:l}=await g.storage.from("chat-attachments").upload(i,t,{cacheControl:"3600",upsert:!1});if(l)throw new Error(`Upload failed: ${l.message}`);const{data:c}=g.storage.from("chat-attachments").getPublicUrl(o.path);return{url:c.publicUrl,type:t.type,name:t.name,size:t.size}};function T({onSendMessage:t}){const[r,a]=u.useState(""),[s,n]=u.useState(!1),{user:i}=w(),{toast:o}=M(),l=N(),c=u.useRef(null),d=h=>{h.preventDefault(),r.trim()&&(t(r),a(""))},m=async h=>{const p=h.target.files?.[0];if(p){if(!i){o({title:"Error",description:"You must be logged in to upload files",variant:"destructive"});return}n(!0);try{const b=await ve(p,i.id);t(`ðŸ“Ž ${p.name}`,b),o({title:"Success",description:"File uploaded successfully"})}catch(b){console.error("Upload error:",b),o({title:"Upload failed",description:b instanceof Error?b.message:"Failed to upload file",variant:"destructive"})}finally{n(!1),c.current&&(c.current.value="")}}};return e.jsx("div",{className:"w-full bg-white dark:bg-[#161b22] border-t border-gray-100 dark:border-[#30363d] px-2 py-2 rounded-b-xl shadow-lg",children:e.jsxs("form",{onSubmit:d,className:"flex items-end gap-2",autoComplete:"off",children:[e.jsxs("div",{className:"flex-shrink-0",children:[e.jsx("input",{ref:c,type:"file",onChange:m,className:"hidden",disabled:s}),e.jsxs(_,{type:"button",variant:"ghost",size:"icon",className:`
              h-12 w-12
              rounded-full hover:bg-gray-100 dark:hover:bg-[#252525]
              text-gray-500 dark:text-gray-400 transition-all duration-150
              focus-visible:ring-2 focus-visible:ring-[#025803]
              border border-transparent
              active:scale-90
            `,style:{minWidth:44,minHeight:44},onClick:()=>c.current?.click(),disabled:s,children:[e.jsx(G,{size:l?20:22}),e.jsx("span",{className:"sr-only",children:"Attach file"})]})]}),e.jsx("div",{className:"flex-1 relative",children:e.jsxs("div",{className:"flex items-end",children:[e.jsx("textarea",{placeholder:s?"Uploading...":"Type your message...",className:`
                flex-1 resize-none border border-gray-200 dark:border-[#30363d]
                rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#025803]
                focus:border-transparent text-gray-900 dark:text-gray-100
                placeholder-gray-500 dark:placeholder-gray-400 bg-gray-50 dark:bg-[#0d1117]
                shadow-md transition-all duration-150
                ${l?"p-4 text-base min-h-[44px] max-h-32":"p-4 text-sm min-h-[52px] max-h-40"}
              `,value:r,onChange:h=>a(h.target.value),disabled:s,rows:1,style:{height:"auto",minHeight:l?"44px":"52px"},onInput:h=>{const p=h.target;p.style.height="auto",p.style.height=Math.min(p.scrollHeight,l?128:160)+"px"},onKeyDown:h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),d(h))}}),e.jsxs(_,{type:"submit",size:"icon",className:`
                ${l?"h-12 w-12 ml-2":"h-12 w-12 ml-3"}
                rounded-full bg-[#025803] hover:bg-[#014502]
                shadow-lg active:scale-90 transition-all duration-100
                disabled:opacity-60 flex-shrink-0
                text-white
              `,style:{minWidth:44,minHeight:44},disabled:!r.trim()||s,children:[e.jsx(Y,{size:l?18:20}),e.jsx("span",{className:"sr-only",children:"Send message"})]})]})})]})})}function U({onSendMessage:t,isMobile:r}){const a="chat-mobile-input-portal",s=u.useRef(null);return u.useEffect(()=>{if(r){let n=document.getElementById(a);return n||(n=document.createElement("div"),n.id=a,document.body.appendChild(n)),n instanceof HTMLDivElement?s.current=n:s.current=null,()=>{n&&n.parentNode&&n.childElementCount===0&&n.parentNode.removeChild(n)}}},[r]),r&&s.current?A.createPortal(e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-50 bg-white dark:bg-[#1a1a1a] border-t border-gray-200 dark:border-[#2a2a2a] shadow-lg",children:e.jsx("div",{className:"pb-safe",children:e.jsx(T,{onSendMessage:t})})}),s.current):e.jsx("div",{className:"shrink-0 border-t border-gray-200 dark:border-[#2a2a2a] bg-white dark:bg-[#1a1a1a] shadow-lg",children:e.jsx(T,{onSendMessage:t})})}function je(){return e.jsx("div",{className:"flex-1 flex items-center justify-center p-8",children:e.jsxs("div",{className:"text-center max-w-md",children:[e.jsxs("div",{className:"relative mb-8",children:[e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-mental-green-100 to-mental-green-200 dark:from-[#025803]/20 dark:to-[#025803]/30 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(S,{className:"w-10 h-10 text-mental-green-600 dark:text-[#025803]"})}),e.jsx("div",{className:"absolute -top-2 -right-2 w-8 h-8 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center",children:e.jsx(P,{className:"w-4 h-4 text-yellow-600 dark:text-yellow-400"})})]}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3",children:"Welcome to Messages"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-300 leading-relaxed mb-6",children:"Select a conversation from the sidebar to start chatting with consultants and get the support you need."}),e.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-gray-500 dark:text-gray-400",children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{children:"Connect â€¢ Share â€¢ Grow"})]})]})})}function qe(){const{consultantId:t,threadId:r}=H(),{user:a,isAuthenticated:s}=w(),{selectedChatId:n,setSelectedChatId:i}=se(t,r),o=N(),[l,c]=u.useState(!o),{chatParticipants:d,transformedMessages:m,sendMessage:h}=he(n);if(C(),!s)return e.jsx(R,{});const p=x=>{i(x),o&&c(!1)},b=()=>{o&&(c(!0),i(""))},k=(x,y)=>{h(x,y)},f=o?"pb-32":"pb-28";return e.jsxs(O,{showSidebar:!0,hideMobileBottomNav:o&&!!n,children:[e.jsxs("div",{className:"flex h-full min-h-0 overflow-hidden bg-gradient-to-br from-gray-50 to-white dark:from-[#212121] dark:to-[#1a1a1a]",children:[o&&l&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 backdrop-blur-sm animate-fade-in",onClick:()=>c(!1)}),e.jsx("div",{className:`
            ${o?`fixed inset-0 z-50 transform transition-transform duration-300 ${l?"translate-x-0":"-translate-x-full"} animate-fade-in`:"w-80"}
            ${o?"":"border-r border-gray-200/80 dark:border-[#2a2a2a]/80"}
            bg-white dark:bg-[#1a1a1a] h-full shrink-0 overflow-hidden
            flex flex-col
          `,children:e.jsx(ae,{selectedChatId:n,onSelectChat:p})}),e.jsx("div",{className:`
            flex-1 flex flex-col min-w-0 bg-white dark:bg-[#1a1a1a] overflow-hidden animate-fade-in
            ${o&&l?"hidden":"flex"}
            h-[calc(100vh-3.5rem)]
          `,children:e.jsxs("div",{className:"flex flex-col h-full min-h-0 overflow-hidden",children:[e.jsx("div",{className:"shrink-0 z-30 bg-white dark:bg-[#1a1a1a] shadow-md transition-all",children:o?e.jsx("div",{className:"bg-white/95 dark:bg-[#1a1a1a]/95 backdrop-blur-sm border-b border-gray-200/80 dark:border-[#2a2a2a]/80",children:e.jsx("div",{className:"flex items-center justify-between p-3 h-[73px]",children:n?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:b,className:"flex items-center gap-1 text-[#025803] dark:text-[#025803] font-medium -ml-2",children:e.jsx(K,{className:"w-5 h-5"})}),e.jsx("div",{className:"flex-1 min-w-0 flex justify-center",children:e.jsx(q,{participants:d,currentUserId:a?.id})}),e.jsx("div",{className:"w-8"})]}):e.jsxs("button",{onClick:()=>c(!0),className:"flex items-center gap-2 text-[#025803] dark:text-[#025803] font-medium",children:[e.jsx(Q,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"Messages"})]})})}):n&&e.jsx(ue,{chatParticipants:d,currentUserId:a?.id})}),e.jsx("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:n?e.jsxs(e.Fragment,{children:[e.jsx(we,{chat:{id:n,messages:m,participants:d,lastActive:new Date().toISOString()},isMobile:o,messageAreaBottomPadding:f}),!o&&e.jsx(U,{onSendMessage:k,isMobile:o})]}):e.jsx(je,{})})]})})]}),o&&n&&e.jsx(U,{onSendMessage:k,isMobile:o})]})}export{qe as ChatPage,qe as default};
