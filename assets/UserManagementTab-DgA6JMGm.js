import{j as e}from"./ui-BG7jjlrC.js";import{d as q,u as x,s as a,F as c,f as u,D as b,x as _,y as N,z as f}from"./index-CvhVXczW.js";import{u as U,b as y,c as w}from"./query-C_TmXHuV.js";import"./vendor-CsPsgsBv.js";import{T as A,a as C,b as j,c as o,d as T,e as l}from"./table-ItZkQoZb.js";import{S as h}from"./skeleton-6Y4fJ80v.js";import{A as M,a as $,b as z}from"./avatar-BFIKPfdM.js";import{T as E}from"./trash-2-ylsRDHL7.js";import{f as F}from"./format-Dmqbz6eD.js";import"./router-J7O6VmFe.js";import"./utils-EL5wpLGY.js";import"./supabase-DoZrjKS4.js";import"./en-US-DcT3sm5m.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=q("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),S=()=>{const{isAdmin:t}=x();return U({queryKey:["admin-users"],queryFn:async()=>{if(!t)throw new Error("Unauthorized");const{data:i,error:s}=await a.from("users").select("*").order("created_at",{ascending:!1});if(s)throw console.error("Error fetching users:",s),s;return i},enabled:!!t,retry:2,retryDelay:1e3})},k=()=>{const t=y(),{isAdmin:i}=x();return w({mutationFn:async({userId:s,newRole:n})=>{if(!i)throw new Error("Unauthorized");const{error:d}=await a.from("users").update({role:n}).eq("id",s);if(d)throw d;return{userId:s,newRole:n}},onSuccess:s=>{t.invalidateQueries({queryKey:["admin-users"]}),c({title:"User role updated",description:`User has been promoted to ${s.newRole}.`})},onError:s=>{c({title:"Failed to update user role",description:s.message||"An error occurred while updating the user role.",variant:"destructive"})}})},D=()=>{const t=y(),{isAdmin:i}=x();return w({mutationFn:async s=>{if(!i)throw new Error("Unauthorized");await a.from("comment_votes").delete().eq("user_id",s),await a.from("story_likes").delete().eq("user_id",s),await a.from("story_comments").delete().eq("user_id",s),await a.from("chat_messages").delete().eq("sender_id",s),await a.from("chat_threads").delete().or(`user_id.eq.${s},consultant_id.eq.${s}`),await a.from("consultant_availability").delete().eq("consultant_id",s),await a.from("reviews").delete().or(`user_id.eq.${s},consultant_id.eq.${s}`),await a.from("sessions").delete().or(`user_id.eq.${s},consultant_id.eq.${s}`),await a.from("transactions").delete().or(`user_id.eq.${s},consultant_id.eq.${s}`),await a.from("stories").delete().eq("author_id",s),await a.from("consultants").delete().eq("id",s);const{error:n}=await a.from("users").delete().eq("id",s);if(n)throw n;return{userId:s}},onSuccess:()=>{t.invalidateQueries({queryKey:["admin-users"]}),t.invalidateQueries({queryKey:["admin-consultants"]}),t.invalidateQueries({queryKey:["consultants"]}),t.invalidateQueries({queryKey:["admin-stories"]}),t.invalidateQueries({queryKey:["stories"]}),c({title:"User removed",description:"The user and all their associated data have been completely removed from the platform."})},onError:s=>{c({title:"Failed to remove user",description:s.message||"An error occurred while removing the user.",variant:"destructive"})}})},Z=()=>{const{data:t,isLoading:i,error:s}=S(),n=k(),d=D(),p=(r,m)=>{n.mutate({userId:r,newRole:m})},v=r=>{window.confirm("Are you sure you want to remove this user?")&&d.mutate(r)},g=r=>r.split(" ").map(m=>m[0]).join("").toUpperCase().substring(0,2);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium",children:"User Management"}),e.jsx(u,{size:"sm",children:"Add User"})]}),e.jsx("div",{className:"rounded-md border",children:i?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx(h,{className:"h-12 w-full"}),e.jsx(h,{className:"h-12 w-full"}),e.jsx(h,{className:"h-12 w-full"})]}):s?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("p",{children:"Failed to load users"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.message})]}):t&&t.length>0?e.jsxs(A,{children:[e.jsx(C,{children:e.jsxs(j,{children:[e.jsx(o,{children:"User"}),e.jsx(o,{children:"Email"}),e.jsx(o,{children:"Role"}),e.jsx(o,{children:"Joined"}),e.jsx(o,{className:"text-right",children:"Actions"})]})}),e.jsx(T,{children:t.map(r=>e.jsxs(j,{children:[e.jsx(l,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(M,{children:[e.jsx($,{src:r.profile_image||void 0}),e.jsx(z,{children:g(r.name)})]}),e.jsx("span",{children:r.name})]})}),e.jsx(l,{children:r.email}),e.jsx(l,{children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${r.role==="admin"?"bg-purple-100 text-purple-800":"bg-blue-100 text-blue-800"}`,children:r.role})}),e.jsx(l,{children:F(new Date(r.created_at),"MMM d, yyyy")}),e.jsx(l,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(b,{children:[e.jsx(_,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"icon",children:e.jsx(Q,{className:"h-4 w-4"})})}),e.jsxs(N,{align:"end",children:[e.jsx(f,{onClick:()=>p(r.id,"user"),children:"Set as User"}),e.jsx(f,{onClick:()=>p(r.id,"admin"),children:"Set as Admin"})]})]}),e.jsx(u,{variant:"ghost",size:"icon",onClick:()=>v(r.id),children:e.jsx(E,{className:"h-4 w-4 text-destructive"})})]})})]},r.id))})]}):e.jsx("div",{className:"p-8 text-center",children:e.jsx("p",{children:"No users found"})})})]})};export{Z as UserManagementTab,Z as default};
