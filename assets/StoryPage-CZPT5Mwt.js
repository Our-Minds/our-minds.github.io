import{j as e,a as Pe,u as k,m as Ae,P as D,M as O,d as P,k as E,e as Re}from"./ui-BG7jjlrC.js";import{r as u}from"./vendor-CsPsgsBv.js";import{d as ae,f as N,u as B,a as U,s as w,b as Q,e as _,M as K,T as Te,t as ke,v as Le,D as De,w as ze,x as Me,y as We,z as He,L as V}from"./index-Xuc-BpSe.js";import{A as Fe}from"./arrow-left-KSOXNl8T.js";import{A as J,a as G,b as Z}from"./avatar-EYr9qbO9.js";import{C as ie}from"./clock-BySPzegt.js";import{H as qe}from"./heart-DLI57nol.js";import{f as ee,T as Oe}from"./formatDistanceToNow-DAfwe73b.js";import{b as Be,u as Ie,c as X}from"./query-C_TmXHuV.js";import{T as Ye}from"./trash-2-VGjIV6yN.js";import{L as $e,b as Ve,u as Xe}from"./router-J7O6VmFe.js";import"./utils-EL5wpLGY.js";import"./supabase-DoZrjKS4.js";import"./constructNow-CbkWqtaZ.js";import"./en-US-DcT3sm5m.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=ae("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=ae("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);function Ke({isMobile:t,showComments:r,onClick:s}){return e.jsxs(N,{variant:"ghost",size:"sm",className:`mb-4 flex items-center gap-2 text-[#037004] hover:text-[#025803] hover:bg-[#025803]/10 transition-colors ${t?"mb-2":""}`,onClick:s,children:[e.jsx(Fe,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:t&&r?"Back to Story":"Back to Stories"}),e.jsx("span",{className:"sm:hidden",children:t&&r?"Story":"Back"})]})}function Je(t){const{user:r}=B(),{toast:s}=U(),[a,o]=u.useState(0),[n,l]=u.useState(!1),[c,m]=u.useState(!1),i=async()=>{try{const{data:h,error:x}=await w.from("story_likes").select("id").eq("story_id",t);if(x)throw x;if(o(h?.length||0),r){const{data:f,error:g}=await w.from("story_likes").select("id").eq("story_id",t).eq("user_id",r.id).single();if(g&&g.code!=="PGRST116")throw g;l(!!f)}}catch(h){console.error("Error fetching likes:",h)}},d=async()=>{if(!r){s({title:"Authentication required",description:"Please log in to like stories",variant:"destructive"});return}m(!0);try{if(n){const{error:h}=await w.from("story_likes").delete().eq("story_id",t).eq("user_id",r.id);if(h)throw h;l(!1),o(x=>x-1)}else{const{error:h}=await w.from("story_likes").insert({story_id:t,user_id:r.id});if(h)throw h;l(!0),o(x=>x+1)}}catch(h){console.error("Error toggling like:",h),s({title:"Error",description:"Failed to update like status",variant:"destructive"})}finally{m(!1)}};return u.useEffect(()=>{i()},[t,r]),{likesCount:a,isLiked:n,isLoading:c,toggleLike:d}}function ce({story:t}){const r=Math.ceil(t.content.split(" ").length/200),{likesCount:s,isLiked:a,isLoading:o,toggleLike:n}=Je(t.id),l=Q(),c=m=>{switch(m){case"mental":return"bg-[#037004] text-white border-[#025803]";case"control":return"bg-blue-500 text-white border-blue-600";case"drugs":return"bg-red-500 text-white border-red-600";case"life":return"bg-orange-500 text-white border-orange-600";case"anxiety":return"bg-purple-500 text-white border-purple-600";case"depression":return"bg-indigo-500 text-white border-indigo-600";default:return"bg-gray-500 text-white border-gray-600"}};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:`${l?"p-3":"p-4 sm:p-6"} border-b border-border bg-card flex-shrink-0`,children:[e.jsx("div",{className:"flex flex-col gap-3 mb-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsx("div",{className:`text-xs py-1.5 px-3 rounded-full font-medium shadow-sm w-fit ${c(t.tag_type)}`,children:t.tags[0]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground text-xs",children:[e.jsx(ie,{size:12}),e.jsxs("span",{children:[r," min read"]})]})]})}),e.jsx("h1",{className:`font-bold text-foreground mb-4 leading-tight ${l?"text-lg":"text-xl sm:text-2xl lg:text-3xl"}`,children:t.title}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(J,{className:`ring-1 ring-[#037004] ${l?"h-8 w-8":"h-9 w-9"}`,children:[e.jsx(G,{src:t.author?.profile_image||void 0}),e.jsx(Z,{className:"bg-[#037004] text-white font-semibold text-sm",children:(t.author?.name||"A").charAt(0)})]}),e.jsxs("div",{children:[e.jsx("p",{className:`font-semibold text-foreground ${l?"text-sm":"text-base"}`,children:t.author?.name||"Anonymous"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Published ",ee(new Date(t.published_at),{addSuffix:!0})]})]})]}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("button",{onClick:n,disabled:o,className:_("flex items-center gap-1 px-3 py-1.5 text-xs rounded-full transition-colors","hover:bg-red-500/10 disabled:opacity-50 disabled:cursor-not-allowed",a?"text-red-500 bg-red-500/10":"text-muted-foreground hover:text-red-500"),children:[e.jsx(qe,{size:14,className:_("transition-all",a?"fill-current":"")}),e.jsx("span",{children:s})]})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto bg-background",children:e.jsxs("div",{className:`${l?"p-3":"p-4 sm:p-6"}`,children:[e.jsx("div",{className:"mb-6",children:e.jsx("img",{src:t.cover_image,alt:t.title,className:`w-full rounded-lg object-cover shadow-sm border border-border ${l?"h-40":"h-48 sm:h-64 lg:h-80"}`,onError:m=>{m.target.src="/placeholder.svg"}})}),e.jsx("div",{className:"prose prose-base lg:prose-lg max-w-none",children:e.jsx("div",{className:`text-foreground leading-relaxed space-y-4 ${l?"space-y-3":"space-y-6"}`,children:t.content.split(`

`).map((m,i)=>e.jsx("p",{className:`text-foreground ${l?"text-sm leading-6":"text-base lg:text-lg leading-7 lg:leading-8"}`,children:m},i))})}),e.jsxs("div",{className:`mt-6 pt-4 border-t border-border ${l?"mt-4":"mt-8 pt-6"}`,children:[e.jsx("h3",{className:`font-semibold mb-3 text-foreground ${l?"text-base":"text-lg mb-4"}`,children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.tags.map((m,i)=>e.jsxs("span",{className:`px-3 py-1.5 bg-[#037004]/20 text-[#037004] dark:text-[#4ade80] rounded-full font-medium hover:bg-[#037004]/30 transition-colors cursor-pointer border border-[#037004]/30 ${l?"text-xs":"text-sm"}`,children:["#",m]},i))})]})]})})]})}function Ge(t){const{user:r}=B(),{toast:s}=U(),a=Be(),{data:o=[],isLoading:n}=Ie({queryKey:["comments",t],queryFn:async()=>{const{data:i,error:d}=await w.from("story_comments").select(`
          *,
          users!user_id (
            name,
            profile_image
          )
        `).eq("story_id",t).order("created_at",{ascending:!0});if(d)throw d;let h=[];if(r){const{data:p,error:S}=await w.from("comment_votes").select("comment_id, vote_type").eq("user_id",r.id).in("comment_id",i?.map(v=>v.id)||[]);S||(h=p||[])}const x=(i||[]).map(p=>({id:p.id,story_id:p.story_id,user_id:p.user_id,parent_comment_id:p.parent_comment_id,content:p.content,upvotes:p.upvotes,downvotes:p.downvotes,is_edited:p.is_edited,created_at:p.created_at,updated_at:p.updated_at,author:p.users?{name:p.users.name,profile_image:p.users.profile_image}:void 0,user_vote:h.find(S=>S.comment_id===p.id)?.vote_type||null})),f=new Map,g=[];return x.forEach(p=>{f.set(p.id,{...p,replies:[]})}),x.forEach(p=>{if(p.parent_comment_id){const S=f.get(p.parent_comment_id);S&&S.replies.push(f.get(p.id))}else g.push(f.get(p.id))}),g},enabled:!!t}),l=X({mutationFn:async({content:i,parentCommentId:d})=>{if(!r)throw new Error("Must be logged in to comment");const{data:h,error:x}=await w.from("story_comments").insert({story_id:t,user_id:r.id,parent_comment_id:d||null,content:i}).select().single();if(x)throw x;return h},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]}),s({title:"Comment posted",description:"Your comment has been added successfully."})},onError:i=>{s({title:"Failed to post comment",description:i.message||"Could not post your comment",variant:"destructive"})}}),c=X({mutationFn:async({commentId:i,voteType:d})=>{if(!r)throw new Error("Must be logged in to vote");if(d===null){const{error:h}=await w.from("comment_votes").delete().eq("comment_id",i).eq("user_id",r.id);if(h)throw h}else{const{error:h}=await w.from("comment_votes").upsert({comment_id:i,user_id:r.id,vote_type:d});if(h)throw h}},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]})},onError:i=>{s({title:"Failed to vote",description:i.message||"Could not register your vote",variant:"destructive"})}}),m=X({mutationFn:async i=>{if(!r)throw new Error("Must be logged in to delete comments");const{error:d}=await w.from("story_comments").delete().eq("id",i).eq("user_id",r.id);if(d)throw d},onSuccess:()=>{a.invalidateQueries({queryKey:["comments",t]}),s({title:"Comment deleted",description:"Your comment has been deleted successfully."})},onError:i=>{s({title:"Failed to delete comment",description:i.message||"Could not delete your comment",variant:"destructive"})}});return{comments:o,isLoading:n,addComment:l.mutate,voteComment:c.mutate,deleteComment:m.mutate,isAddingComment:l.isPending,isVoting:c.isPending,isDeleting:m.isPending}}function de({onSubmit:t,onCancel:r,placeholder:s="Write a comment...",submitText:a="Post Comment",isSubmitting:o=!1,isReply:n=!1}){const[l,c]=u.useState(""),{isAuthenticated:m}=B(),i=d=>{d.preventDefault(),l.trim()&&(t(l.trim()),c(""))};return m?e.jsxs("form",{onSubmit:i,className:"space-y-3",children:[e.jsx(Te,{value:l,onChange:d=>c(d.target.value),placeholder:s,className:"min-h-[80px] resize-none",disabled:o}),e.jsxs("div",{className:"flex justify-end gap-2",children:[r&&e.jsx(N,{type:"button",variant:"outline",onClick:r,disabled:o,children:"Cancel"}),e.jsx(N,{type:"submit",disabled:!l.trim()||o,size:n?"sm":"default",className:"bg-[#037004] hover:bg-[#025803] text-white",children:o?"Posting...":a})]})]}):e.jsxs("div",{className:"p-4 text-center text-muted-foreground bg-muted rounded-lg border border-border",children:[e.jsx(K,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),e.jsx("p",{children:"Please log in to join the discussion"})]})}function ue({comment:t,onVote:r,onReply:s,onDelete:a,isVoting:o=!1,isReplying:n=!1,isDeleting:l=!1,depth:c=0}){const[m,i]=u.useState(!1),[d,h]=u.useState(!1),{user:x}=B(),f=v=>{const A=t.user_vote===v?null:v;r(t.id,A)},g=v=>{s(t.id,v),i(!1)},p=t.upvotes-t.downvotes;return e.jsxs("div",{className:_("space-y-3",c>0&&"ml-6 border-l-2 border-gray-100 pl-4"),children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(J,{className:"h-6 w-6",children:[e.jsx(G,{src:t.author?.profile_image||void 0}),e.jsx(Z,{className:"text-xs",children:t.author?.name?.charAt(0)||"A"})]}),e.jsx("span",{className:"font-medium text-sm",children:t.author?.name||"Anonymous"}),e.jsx("span",{className:"text-xs text-gray-500",children:ee(new Date(t.created_at),{addSuffix:!0})}),t.is_edited&&e.jsx("span",{className:"text-xs text-gray-400",children:"(edited)"})]}),!d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:t.content}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{variant:"ghost",size:"sm",className:_("h-6 px-1",t.user_vote==="upvote"&&"text-orange-500 bg-orange-50"),onClick:()=>f("upvote"),disabled:o,children:e.jsx(ke,{size:14})}),e.jsx("span",{className:_("text-xs font-medium min-w-[20px] text-center",p>0&&"text-orange-500",p<0&&"text-blue-500"),children:p}),e.jsx(N,{variant:"ghost",size:"sm",className:_("h-6 px-1",t.user_vote==="downvote"&&"text-blue-500 bg-blue-50"),onClick:()=>f("downvote"),disabled:o,children:e.jsx(Le,{size:14})})]}),c<6&&e.jsxs(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>i(!m),children:[e.jsx(Qe,{size:12,className:"mr-1"}),"Reply"]}),t.replies&&t.replies.length>0&&e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs",onClick:()=>h(!d),children:d?`[+] ${t.replies.length} replies`:"[-]"}),x&&x.id===t.user_id&&e.jsxs(De,{children:[e.jsx(ze,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"sm",className:"h-6 px-1",children:e.jsx(Ue,{size:12})})}),e.jsx(Me,{align:"end",children:e.jsxs(We,{onClick:()=>a(t.id),disabled:l,className:"text-destructive focus:text-destructive",children:[e.jsx(Ye,{size:12,className:"mr-2"}),"Delete"]})})]})]})]}),d&&e.jsxs(N,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-gray-500",onClick:()=>h(!1),children:["[+] ",t.author?.name," (",p," points) - ",t.replies?.length||0," replies"]}),m&&!d&&e.jsx("div",{className:"mt-3",children:e.jsx(de,{onSubmit:g,onCancel:()=>i(!1),placeholder:"Write a reply...",submitText:"Reply",isSubmitting:n,isReply:!0})})]}),!d&&t.replies&&t.replies.length>0&&e.jsx("div",{className:"space-y-3",children:t.replies.map(v=>e.jsx(ue,{comment:v,onVote:r,onReply:s,onDelete:a,isVoting:o,isReplying:n,isDeleting:l,depth:c+1},v.id))})]})}function Ze(t,r){return u.useReducer((s,a)=>r[s][a]??s,t)}var te="ScrollArea",[me,Tt]=Pe(te),[et,j]=me(te),he=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,type:a="hover",dir:o,scrollHideDelay:n=600,...l}=t,[c,m]=u.useState(null),[i,d]=u.useState(null),[h,x]=u.useState(null),[f,g]=u.useState(null),[p,S]=u.useState(null),[v,A]=u.useState(0),[$,z]=u.useState(0),[M,L]=u.useState(!1),[W,H]=u.useState(!1),b=k(r,R=>m(R)),y=Ae(o);return e.jsx(et,{scope:s,type:a,dir:y,scrollHideDelay:n,scrollArea:c,viewport:i,onViewportChange:d,content:h,onContentChange:x,scrollbarX:f,onScrollbarXChange:g,scrollbarXEnabled:M,onScrollbarXEnabledChange:L,scrollbarY:p,onScrollbarYChange:S,scrollbarYEnabled:W,onScrollbarYEnabledChange:H,onCornerWidthChange:A,onCornerHeightChange:z,children:e.jsx(D.div,{dir:y,...l,ref:b,style:{position:"relative","--radix-scroll-area-corner-width":v+"px","--radix-scroll-area-corner-height":$+"px",...t.style}})})});he.displayName=te;var xe="ScrollAreaViewport",fe=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,children:a,asChild:o,nonce:n,...l}=t,c=j(xe,s),m=u.useRef(null),i=k(r,m,c.onViewportChange);return e.jsxs(e.Fragment,{children:[e.jsx("style",{dangerouslySetInnerHTML:{__html:`
[data-radix-scroll-area-viewport] {
  scrollbar-width: none;
  -ms-overflow-style: none;
  -webkit-overflow-scrolling: touch;
}
[data-radix-scroll-area-viewport]::-webkit-scrollbar {
  display: none;
}
:where([data-radix-scroll-area-viewport]) {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
:where([data-radix-scroll-area-content]) {
  flex-grow: 1;
}
`},nonce:n}),e.jsx(D.div,{"data-radix-scroll-area-viewport":"",...l,asChild:o,ref:i,style:{overflowX:c.scrollbarXEnabled?"scroll":"hidden",overflowY:c.scrollbarYEnabled?"scroll":"hidden",...t.style},children:dt({asChild:o,children:a},d=>e.jsx("div",{"data-radix-scroll-area-content":"",ref:c.onContentChange,style:{minWidth:c.scrollbarXEnabled?"fit-content":void 0},children:d}))})]})});fe.displayName=xe;var C="ScrollAreaScrollbar",re=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),{onScrollbarXEnabledChange:n,onScrollbarYEnabledChange:l}=o,c=t.orientation==="horizontal";return u.useEffect(()=>(c?n(!0):l(!0),()=>{c?n(!1):l(!1)}),[c,n,l]),o.type==="hover"?e.jsx(tt,{...a,ref:r,forceMount:s}):o.type==="scroll"?e.jsx(rt,{...a,ref:r,forceMount:s}):o.type==="auto"?e.jsx(pe,{...a,ref:r,forceMount:s}):o.type==="always"?e.jsx(se,{...a,ref:r}):null});re.displayName=C;var tt=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),[n,l]=u.useState(!1);return u.useEffect(()=>{const c=o.scrollArea;let m=0;if(c){const i=()=>{window.clearTimeout(m),l(!0)},d=()=>{m=window.setTimeout(()=>l(!1),o.scrollHideDelay)};return c.addEventListener("pointerenter",i),c.addEventListener("pointerleave",d),()=>{window.clearTimeout(m),c.removeEventListener("pointerenter",i),c.removeEventListener("pointerleave",d)}}},[o.scrollArea,o.scrollHideDelay]),e.jsx(O,{present:s||n,children:e.jsx(pe,{"data-state":n?"visible":"hidden",...a,ref:r})})}),rt=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=j(C,t.__scopeScrollArea),n=t.orientation==="horizontal",l=Y(()=>m("SCROLL_END"),100),[c,m]=Ze("hidden",{hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}});return u.useEffect(()=>{if(c==="idle"){const i=window.setTimeout(()=>m("HIDE"),o.scrollHideDelay);return()=>window.clearTimeout(i)}},[c,o.scrollHideDelay,m]),u.useEffect(()=>{const i=o.viewport,d=n?"scrollLeft":"scrollTop";if(i){let h=i[d];const x=()=>{const f=i[d];h!==f&&(m("SCROLL"),l()),h=f};return i.addEventListener("scroll",x),()=>i.removeEventListener("scroll",x)}},[o.viewport,n,m,l]),e.jsx(O,{present:s||c!=="hidden",children:e.jsx(se,{"data-state":c==="hidden"?"hidden":"visible",...a,ref:r,onPointerEnter:P(t.onPointerEnter,()=>m("POINTER_ENTER")),onPointerLeave:P(t.onPointerLeave,()=>m("POINTER_LEAVE"))})})}),pe=u.forwardRef((t,r)=>{const s=j(C,t.__scopeScrollArea),{forceMount:a,...o}=t,[n,l]=u.useState(!1),c=t.orientation==="horizontal",m=Y(()=>{if(s.viewport){const i=s.viewport.offsetWidth<s.viewport.scrollWidth,d=s.viewport.offsetHeight<s.viewport.scrollHeight;l(c?i:d)}},10);return T(s.viewport,m),T(s.content,m),e.jsx(O,{present:a||n,children:e.jsx(se,{"data-state":n?"visible":"hidden",...o,ref:r})})}),se=u.forwardRef((t,r)=>{const{orientation:s="vertical",...a}=t,o=j(C,t.__scopeScrollArea),n=u.useRef(null),l=u.useRef(0),[c,m]=u.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),i=je(c.viewport,c.content),d={...a,sizes:c,onSizesChange:m,hasThumb:i>0&&i<1,onThumbChange:x=>n.current=x,onThumbPointerUp:()=>l.current=0,onThumbPointerDown:x=>l.current=x};function h(x,f){return it(x,l.current,c,f)}return s==="horizontal"?e.jsx(st,{...d,ref:r,onThumbPositionChange:()=>{if(o.viewport&&n.current){const x=o.viewport.scrollLeft,f=le(x,c,o.dir);n.current.style.transform=`translate3d(${f}px, 0, 0)`}},onWheelScroll:x=>{o.viewport&&(o.viewport.scrollLeft=x)},onDragScroll:x=>{o.viewport&&(o.viewport.scrollLeft=h(x,o.dir))}}):s==="vertical"?e.jsx(ot,{...d,ref:r,onThumbPositionChange:()=>{if(o.viewport&&n.current){const x=o.viewport.scrollTop,f=le(x,c);n.current.style.transform=`translate3d(0, ${f}px, 0)`}},onWheelScroll:x=>{o.viewport&&(o.viewport.scrollTop=x)},onDragScroll:x=>{o.viewport&&(o.viewport.scrollTop=h(x))}}):null}),st=u.forwardRef((t,r)=>{const{sizes:s,onSizesChange:a,...o}=t,n=j(C,t.__scopeScrollArea),[l,c]=u.useState(),m=u.useRef(null),i=k(r,m,n.onScrollbarXChange);return u.useEffect(()=>{m.current&&c(getComputedStyle(m.current))},[m]),e.jsx(be,{"data-orientation":"horizontal",...o,ref:i,sizes:s,style:{bottom:0,left:n.dir==="rtl"?"var(--radix-scroll-area-corner-width)":0,right:n.dir==="ltr"?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":I(s)+"px",...t.style},onThumbPointerDown:d=>t.onThumbPointerDown(d.x),onDragScroll:d=>t.onDragScroll(d.x),onWheelScroll:(d,h)=>{if(n.viewport){const x=n.viewport.scrollLeft+d.deltaX;t.onWheelScroll(x),ye(x,h)&&d.preventDefault()}},onResize:()=>{m.current&&n.viewport&&l&&a({content:n.viewport.scrollWidth,viewport:n.viewport.offsetWidth,scrollbar:{size:m.current.clientWidth,paddingStart:q(l.paddingLeft),paddingEnd:q(l.paddingRight)}})}})}),ot=u.forwardRef((t,r)=>{const{sizes:s,onSizesChange:a,...o}=t,n=j(C,t.__scopeScrollArea),[l,c]=u.useState(),m=u.useRef(null),i=k(r,m,n.onScrollbarYChange);return u.useEffect(()=>{m.current&&c(getComputedStyle(m.current))},[m]),e.jsx(be,{"data-orientation":"vertical",...o,ref:i,sizes:s,style:{top:0,right:n.dir==="ltr"?0:void 0,left:n.dir==="rtl"?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":I(s)+"px",...t.style},onThumbPointerDown:d=>t.onThumbPointerDown(d.y),onDragScroll:d=>t.onDragScroll(d.y),onWheelScroll:(d,h)=>{if(n.viewport){const x=n.viewport.scrollTop+d.deltaY;t.onWheelScroll(x),ye(x,h)&&d.preventDefault()}},onResize:()=>{m.current&&n.viewport&&l&&a({content:n.viewport.scrollHeight,viewport:n.viewport.offsetHeight,scrollbar:{size:m.current.clientHeight,paddingStart:q(l.paddingTop),paddingEnd:q(l.paddingBottom)}})}})}),[nt,ge]=me(C),be=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,sizes:a,hasThumb:o,onThumbChange:n,onThumbPointerUp:l,onThumbPointerDown:c,onThumbPositionChange:m,onDragScroll:i,onWheelScroll:d,onResize:h,...x}=t,f=j(C,s),[g,p]=u.useState(null),S=k(r,b=>p(b)),v=u.useRef(null),A=u.useRef(""),$=f.viewport,z=a.content-a.viewport,M=E(d),L=E(m),W=Y(h,10);function H(b){if(v.current){const y=b.clientX-v.current.left,R=b.clientY-v.current.top;i({x:y,y:R})}}return u.useEffect(()=>{const b=y=>{const R=y.target;g?.contains(R)&&M(y,z)};return document.addEventListener("wheel",b,{passive:!1}),()=>document.removeEventListener("wheel",b,{passive:!1})},[$,g,z,M]),u.useEffect(L,[a,L]),T(g,W),T(f.content,W),e.jsx(nt,{scope:s,scrollbar:g,hasThumb:o,onThumbChange:E(n),onThumbPointerUp:E(l),onThumbPositionChange:L,onThumbPointerDown:E(c),children:e.jsx(D.div,{...x,ref:S,style:{position:"absolute",...x.style},onPointerDown:P(t.onPointerDown,b=>{b.button===0&&(b.target.setPointerCapture(b.pointerId),v.current=g.getBoundingClientRect(),A.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",f.viewport&&(f.viewport.style.scrollBehavior="auto"),H(b))}),onPointerMove:P(t.onPointerMove,H),onPointerUp:P(t.onPointerUp,b=>{const y=b.target;y.hasPointerCapture(b.pointerId)&&y.releasePointerCapture(b.pointerId),document.body.style.webkitUserSelect=A.current,f.viewport&&(f.viewport.style.scrollBehavior=""),v.current=null})})})}),F="ScrollAreaThumb",ve=u.forwardRef((t,r)=>{const{forceMount:s,...a}=t,o=ge(F,t.__scopeScrollArea);return e.jsx(O,{present:s||o.hasThumb,children:e.jsx(lt,{ref:r,...a})})}),lt=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,style:a,...o}=t,n=j(F,s),l=ge(F,s),{onThumbPositionChange:c}=l,m=k(r,h=>l.onThumbChange(h)),i=u.useRef(),d=Y(()=>{i.current&&(i.current(),i.current=void 0)},100);return u.useEffect(()=>{const h=n.viewport;if(h){const x=()=>{if(d(),!i.current){const f=ct(h,c);i.current=f,c()}};return c(),h.addEventListener("scroll",x),()=>h.removeEventListener("scroll",x)}},[n.viewport,d,c]),e.jsx(D.div,{"data-state":l.hasThumb?"visible":"hidden",...o,ref:m,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...a},onPointerDownCapture:P(t.onPointerDownCapture,h=>{const f=h.target.getBoundingClientRect(),g=h.clientX-f.left,p=h.clientY-f.top;l.onThumbPointerDown({x:g,y:p})}),onPointerUp:P(t.onPointerUp,l.onThumbPointerUp)})});ve.displayName=F;var oe="ScrollAreaCorner",we=u.forwardRef((t,r)=>{const s=j(oe,t.__scopeScrollArea),a=!!(s.scrollbarX&&s.scrollbarY);return s.type!=="scroll"&&a?e.jsx(at,{...t,ref:r}):null});we.displayName=oe;var at=u.forwardRef((t,r)=>{const{__scopeScrollArea:s,...a}=t,o=j(oe,s),[n,l]=u.useState(0),[c,m]=u.useState(0),i=!!(n&&c);return T(o.scrollbarX,()=>{const d=o.scrollbarX?.offsetHeight||0;o.onCornerHeightChange(d),m(d)}),T(o.scrollbarY,()=>{const d=o.scrollbarY?.offsetWidth||0;o.onCornerWidthChange(d),l(d)}),i?e.jsx(D.div,{...a,ref:r,style:{width:n,height:c,position:"absolute",right:o.dir==="ltr"?0:void 0,left:o.dir==="rtl"?0:void 0,bottom:0,...t.style}}):null});function q(t){return t?parseInt(t,10):0}function je(t,r){const s=t/r;return isNaN(s)?0:s}function I(t){const r=je(t.viewport,t.content),s=t.scrollbar.paddingStart+t.scrollbar.paddingEnd,a=(t.scrollbar.size-s)*r;return Math.max(a,18)}function it(t,r,s,a="ltr"){const o=I(s),n=o/2,l=r||n,c=o-l,m=s.scrollbar.paddingStart+l,i=s.scrollbar.size-s.scrollbar.paddingEnd-c,d=s.content-s.viewport,h=a==="ltr"?[0,d]:[d*-1,0];return Se([m,i],h)(t)}function le(t,r,s="ltr"){const a=I(r),o=r.scrollbar.paddingStart+r.scrollbar.paddingEnd,n=r.scrollbar.size-o,l=r.content-r.viewport,c=n-a,m=s==="ltr"?[0,l]:[l*-1,0],i=He(t,m);return Se([0,l],[0,c])(i)}function Se(t,r){return s=>{if(t[0]===t[1]||r[0]===r[1])return r[0];const a=(r[1]-r[0])/(t[1]-t[0]);return r[0]+a*(s-t[0])}}function ye(t,r){return t>0&&t<r}var ct=(t,r=()=>{})=>{let s={left:t.scrollLeft,top:t.scrollTop},a=0;return function o(){const n={left:t.scrollLeft,top:t.scrollTop},l=s.left!==n.left,c=s.top!==n.top;(l||c)&&r(),s=n,a=window.requestAnimationFrame(o)}(),()=>window.cancelAnimationFrame(a)};function Y(t,r){const s=E(t),a=u.useRef(0);return u.useEffect(()=>()=>window.clearTimeout(a.current),[]),u.useCallback(()=>{window.clearTimeout(a.current),a.current=window.setTimeout(s,r)},[s,r])}function T(t,r){const s=E(r);Re(()=>{let a=0;if(t){const o=new ResizeObserver(()=>{cancelAnimationFrame(a),a=window.requestAnimationFrame(s)});return o.observe(t),()=>{window.cancelAnimationFrame(a),o.unobserve(t)}}},[t,s])}function dt(t,r){const{asChild:s,children:a}=t;if(!s)return typeof r=="function"?r(a):r;const o=u.Children.only(a);return u.cloneElement(o,{children:typeof r=="function"?r(o.props.children):r})}var Ne=he,ut=fe,mt=we;const ne=u.forwardRef(({className:t,children:r,...s},a)=>e.jsxs(Ne,{ref:a,className:_("relative overflow-hidden",t),...s,children:[e.jsx(ut,{className:"h-full w-full rounded-[inherit]",children:r}),e.jsx(Ce,{}),e.jsx(mt,{})]}));ne.displayName=Ne.displayName;const Ce=u.forwardRef(({className:t,orientation:r="vertical",...s},a)=>e.jsx(re,{ref:a,orientation:r,className:_("flex touch-none select-none transition-colors",r==="vertical"&&"h-full w-1.5 border-l border-l-transparent p-[1px] opacity-0 hover:opacity-100",r==="horizontal"&&"h-1.5 flex-col border-t border-t-transparent p-[1px] opacity-0 hover:opacity-100",t),...s,children:e.jsx(ve,{className:"relative flex-1 rounded-full bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors"})}));Ce.displayName=re.displayName;function _e({storyId:t}){const{comments:r,isLoading:s,addComment:a,voteComment:o,deleteComment:n,isAddingComment:l,isVoting:c,isDeleting:m}=Ge(t),i=f=>{a({content:f})},d=(f,g)=>{a({content:g,parentCommentId:f})},h=(f,g)=>{o({commentId:f,voteType:g})},x=f=>{n(f)};return s?e.jsx("div",{className:"h-full flex items-center justify-center p-4",children:e.jsx("div",{className:"text-center text-[#037004]",children:"Loading comments..."})}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-border bg-muted flex-shrink-0",children:e.jsx(de,{onSubmit:i,isSubmitting:l})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(ne,{className:"h-full",children:r.length===0?e.jsxs("div",{className:"text-center py-6 px-4 text-muted-foreground",children:[e.jsx(K,{className:"mx-auto h-8 w-8 mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No comments yet. Be the first to share your thoughts!"})]}):e.jsx("div",{className:"p-3 space-y-3",children:r.map(f=>e.jsx(ue,{comment:f,onVote:h,onReply:d,onDelete:x,isVoting:c,isReplying:l,isDeleting:m},f.id))})})})]})}function Ee({currentStory:t}){const[r,s]=u.useState([]),[a,o]=u.useState(!0);return u.useEffect(()=>{(async()=>{try{const{data:l,error:c}=await w.from("stories").select("*").eq("tag_type",t.tag_type).neq("id",t.id).limit(5);if(c)throw c;const m=(l||[]).map(i=>{const d=i.tag_type;return{...i,tag_type:d,author:{name:"Anonymous",profile_image:null}}});s(m)}catch(l){console.error("Error fetching similar stories:",l)}finally{o(!1)}})()},[t.tag_type,t.id]),a?e.jsx("div",{className:"p-3",children:e.jsx("div",{className:"space-y-3",children:[1,2,3].map(n=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-muted rounded mb-2"}),e.jsx("div",{className:"h-3 bg-muted rounded w-3/4"})]},n))})}):r.length===0?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(Oe,{className:"mx-auto h-8 w-8 text-muted-foreground mb-2"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"No similar stories found"})]}):e.jsx(ne,{className:"h-full",children:e.jsx("div",{className:"p-3 space-y-3",children:r.map((n,l)=>e.jsx($e,{to:`/story/${n.id}`,className:"block group",children:e.jsx("div",{className:"p-3 rounded-lg border border-border hover:border-[#037004] hover:bg-accent transition-all duration-200 group-hover:shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsxs(J,{className:"h-7 w-7",children:[e.jsx(G,{src:n.author?.profile_image||void 0}),e.jsx(Z,{className:"bg-[#037004] text-white text-xs",children:(n.author?.name||"A").charAt(0)})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground text-sm line-clamp-2 group-hover:text-[#037004] transition-colors mb-1",children:n.title}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2 mb-2",children:n.snippet}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"truncate",children:n.author?.name||"Anonymous"}),e.jsx("span",{children:"â€¢"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{size:10}),e.jsx("span",{children:ee(new Date(n.published_at),{addSuffix:!0})})]})]}),e.jsx("span",{className:"text-white text-xs py-0.5 px-2 rounded-full font-medium flex-shrink-0 bg-[#037004]",children:n.tags[0]})]})]})]})})},n.id))})})}function ht({story:t}){const[r,s]=u.useState(!1);return e.jsx("div",{className:"space-y-4",children:r?e.jsxs("div",{className:"bg-card rounded-lg shadow-sm border border-border min-h-[calc(100vh-8rem)]",children:[e.jsxs("div",{className:"p-3 border-b border-border bg-muted",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-lg",children:"Discussion"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:['Join the conversation about "',t.title,'"']})]}),e.jsx("div",{className:"h-[calc(100vh-12rem)]",children:e.jsx(_e,{storyId:t.id})}),e.jsx("div",{className:"mt-3 flex justify-center",children:e.jsx(N,{variant:"outline",size:"sm",onClick:()=>s(!1),className:"text-[#037004] border-[#037004]",children:"Back to Story"})})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-card rounded-lg shadow-sm border border-border overflow-hidden",children:e.jsx(ce,{story:t})}),e.jsx("div",{className:"flex justify-center",children:e.jsxs(N,{onClick:()=>s(!0),className:"bg-[#037004] hover:bg-[#025803] text-white flex items-center gap-2 px-6 py-3 rounded-full shadow-lg",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"View Comments & Discussion"})]})}),e.jsxs("div",{className:"bg-card rounded-lg shadow-sm border border-border",children:[e.jsxs("div",{className:"p-3 border-b border-border bg-muted",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-lg",children:"Similar Stories"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"More stories you might like"})]}),e.jsx("div",{className:"max-h-80 overflow-y-auto",children:e.jsx(Ee,{currentStory:t})})]})]})})}function xt({story:t}){return Q()?e.jsx(ht,{story:t}):e.jsxs("div",{className:"flex gap-6 h-[calc(100vh-8rem)]",children:[e.jsx("div",{className:"flex-1 lg:w-2/3 flex flex-col min-h-0",children:e.jsx("div",{className:"bg-card rounded-xl shadow-sm border border-border flex-1 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[e.jsx(ce,{story:t}),e.jsxs("div",{className:"border-t border-border mt-4",children:[e.jsxs("div",{className:"p-6 bg-muted border-b border-border",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-xl",children:"Similar Stories"}),e.jsx("p",{className:"text-base text-muted-foreground",children:"More stories you might like"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto bg-card",children:e.jsx(Ee,{currentStory:t})})]})]})})}),e.jsx("div",{className:"lg:w-1/3 flex flex-col min-h-0",children:e.jsxs("div",{className:"bg-card rounded-xl shadow-sm border border-border flex flex-col h-full overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-border bg-muted flex-shrink-0",children:[e.jsx("h3",{className:"font-semibold text-[#037004] text-xl",children:"Discussion"}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Join the conversation"})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(_e,{storyId:t.id})})]})})]})}function kt(){const{storyId:t}=Ve(),r=Xe(),{toast:s}=U(),[a,o]=u.useState(null),[n,l]=u.useState(!0);u.useState(!1);const c=Q();return u.useEffect(()=>{(async()=>{try{if(!t){r("/");return}const{data:i,error:d}=await w.from("stories").select("*").eq("id",t).single();if(d)throw d;if(i){let h={name:"Anonymous",profile_image:null};if(i.author_id){const{data:g,error:p}=await w.from("users").select("name, profile_image").eq("id",i.author_id).single();!p&&g&&(h=g)}const x=i.tag_type,f={...i,tag_type:x,author:h};o(f),document.title=`${i.title} | Our Minds`}else r("/")}catch(i){console.error("Error fetching story:",i),s({title:"Failed to load story",description:i.message||"Could not retrieve the story",variant:"destructive"}),r("/")}finally{l(!1)}})()},[t,r,s]),n?e.jsx(V,{children:e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"container mx-auto p-4 lg:p-6",children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-pulse text-[#037004]",children:"Loading story..."})})})})}):a?e.jsx(V,{children:e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs("div",{className:`container mx-auto max-w-7xl ${c?"p-2":"p-4 lg:p-6"}`,children:[e.jsx(Ke,{isMobile:c,showComments:!1,onClick:()=>{r(-1)}}),e.jsx(xt,{story:a})]})})}):e.jsx(V,{children:e.jsx("div",{className:"min-h-screen bg-background",children:e.jsx("div",{className:"container mx-auto p-4 lg:p-6",children:e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("p",{className:"text-muted-foreground",children:"Story not found"})})})})})}export{kt as StoryPage,kt as default};
