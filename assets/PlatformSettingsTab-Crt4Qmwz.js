import{j as e}from"./ui-BG7jjlrC.js";import{r as u}from"./vendor-CsPsgsBv.js";import{u as E,s as h,A as b,a as A,V as j,f as v,C as y,h as w,i as N,j as S,k as C,l as c,I as p}from"./index-Xuc-BpSe.js";import{u as P,b as B,c as I}from"./query-C_TmXHuV.js";import{S as f}from"./switch-DgbO84US.js";import"./router-J7O6VmFe.js";import"./utils-EL5wpLGY.js";import"./supabase-DoZrjKS4.js";const L=()=>{const{isAdmin:o}=E();return P({queryKey:["admin-settings"],queryFn:async()=>{if(!o)throw new Error("Unauthorized");try{const{data:a,error:r}=await h.from("platform_settings").select("*").order("created_at",{ascending:!0}).limit(1).maybeSingle();if(r)throw console.error("Error fetching platform settings:",r),r;if(!a){console.log("No platform settings found, creating default");const i={mission:"Our mission is to make mental health support accessible to everyone, everywhere.",vision:"We envision a world where mental health is treated with the same importance as physical health.",values:"Compassion, Accessibility, Quality, Privacy, and Inclusion.",platform_fee_percentage:4},{data:d,error:n}=await h.from("platform_settings").insert(i).select().single();if(n)throw console.error("Error creating default platform settings:",n),n;return d}return a}catch(a){throw console.error("Error in useAdminSettings:",a),a}},enabled:!!o,retry:2,retryDelay:1e3})},q=()=>{const o=B(),{isAdmin:a}=E();return I({mutationFn:async r=>{if(!a)throw new Error("Unauthorized");let i;const{data:d,error:n}=await h.from("platform_settings").select("id").order("created_at",{ascending:!0}).limit(1).single();if(n)if(n.code==="PGRST116"){const{data:t,error:m}=await h.from("platform_settings").insert(r).select("id").single();if(m)throw m;if(!t)throw new Error("Failed to create settings");i=t.id}else throw n;else{i=d.id;const{error:t}=await h.from("platform_settings").update(r).eq("id",i);if(t)throw t}return{...r,id:i}},onSuccess:()=>{o.invalidateQueries({queryKey:["admin-settings"]}),b({title:"Settings saved",description:"Platform settings have been updated successfully."})},onError:r=>{b({title:"Failed to save settings",description:r.message||"An error occurred while saving settings.",variant:"destructive"})}})},G=()=>{const{toast:o}=A(),{data:a,isLoading:r,error:i}=L(),{mutate:d,isPending:n}=q(),[t,m]=u.useState({platformName:"",contactEmail:"",platformFee:4,enableChat:!0,enableBooking:!0,enableStories:!0}),[g,F]=u.useState(!1);u.useEffect(()=>{a&&!g&&(console.log("Loading platform settings into form:",a),m({platformName:a.mission?.split(" - ")[0]||"Mental Health App",contactEmail:a.contact_email||"support@example.com",platformFee:a.platform_fee_percentage||4,enableChat:a.enable_chat??!0,enableBooking:a.enable_booking??!0,enableStories:a.enable_stories??!0}),F(!0))},[a,g]);const l=(s,x)=>{console.log(`Updating ${s} to:`,x),m(_=>({..._,[s]:x}))},k=()=>{if(console.log("Saving platform settings:",t),t.platformFee<0||t.platformFee>100){o({title:"Invalid platform fee",description:"Platform fee must be between 0 and 100%",variant:"destructive"});return}if(!t.contactEmail.includes("@")){o({title:"Invalid email",description:"Please enter a valid contact email",variant:"destructive"});return}if(!t.platformName.trim()){o({title:"Invalid platform name",description:"Platform name cannot be empty",variant:"destructive"});return}d({platform_fee_percentage:t.platformFee,mission:`${t.platformName} - Our mission is to make mental health support accessible to everyone, everywhere.`,contact_email:t.contactEmail,enable_chat:t.enableChat,enable_booking:t.enableBooking,enable_stories:t.enableStories})};return r?e.jsxs("div",{className:"flex items-center justify-center p-8",children:[e.jsx(j,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Loading settings..."})]}):i?e.jsxs("div",{className:"p-4 text-center text-red-600",children:[e.jsxs("p",{children:["Error loading settings: ",i.message]}),e.jsx(v,{onClick:()=>window.location.reload(),variant:"outline",className:"mt-2",children:"Retry"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Platform Settings"}),e.jsxs(v,{onClick:k,disabled:n,children:[n&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Settings"]})]}),e.jsxs(y,{children:[e.jsxs(w,{children:[e.jsx(N,{children:"General Settings"}),e.jsx(S,{children:"Manage platform-wide configuration"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"platformName",children:"Platform Name"}),e.jsx(p,{id:"platformName",type:"text",placeholder:"Mental Health App",value:t.platformName,onChange:s=>l("platformName",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"contactEmail",children:"Contact Email"}),e.jsx(p,{id:"contactEmail",type:"email",placeholder:"support@example.com",value:t.contactEmail,onChange:s=>l("contactEmail",s.target.value)})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"platformFee",children:"Platform Fee (%)"}),e.jsx(p,{id:"platformFee",type:"number",placeholder:"10",min:"0",max:"100",value:t.platformFee,onChange:s=>l("platformFee",parseFloat(s.target.value)||0)})]})]})]}),e.jsxs(y,{children:[e.jsxs(w,{children:[e.jsx(N,{children:"Feature Toggles"}),e.jsx(S,{children:"Enable or disable platform features"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(c,{htmlFor:"enableChat",children:"Enable Chat Feature"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow users to chat with consultants"})]}),e.jsx(f,{id:"enableChat",checked:t.enableChat,onCheckedChange:s=>l("enableChat",s)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(c,{htmlFor:"enableBooking",children:"Enable Consultant Booking"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow users to book sessions with consultants"})]}),e.jsx(f,{id:"enableBooking",checked:t.enableBooking,onCheckedChange:s=>l("enableBooking",s)})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(c,{htmlFor:"enableStories",children:"Enable Public Stories"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow users to view and share stories publicly"})]}),e.jsx(f,{id:"enableStories",checked:t.enableStories,onCheckedChange:s=>l("enableStories",s)})]})]})]})]})};export{G as PlatformSettingsTab,G as default};
